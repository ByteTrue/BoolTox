# å¤–éƒ¨å·¥å…·ç”Ÿå‘½å‘¨æœŸç®¡ç† - äº§å“è®¾è®¡æ–¹æ¡ˆ

> ä»äº§å“è®¾è®¡è§’åº¦è§£å†³ CLI/Binary å·¥å…·çš„çŠ¶æ€åŒæ­¥é—®é¢˜

---

## å½“å‰é—®é¢˜

**ç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒ**ï¼š
```
ç”¨æˆ·å¯åŠ¨ CLI å·¥å…· â†’ åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ â†’ åœ¨ç»ˆç«¯ä¸­é€€å‡º â†’ å›åˆ° BoolTox â†’ ç‚¹å‡»åœæ­¢æŒ‰é’®
                                                      â†‘
                                            ä¸ºä»€ä¹ˆè¿˜è¦è¿™ä¸€æ­¥ï¼Ÿå¾ˆä¸ä¼˜é›…ï¼
```

**æ ¹æœ¬çŸ›ç›¾**ï¼š
- å·¥å…·åœ¨å¤–éƒ¨è¿è¡Œï¼ŒBoolTox æ— æ³•è¿½è¸ªå…¶çŠ¶æ€
- ä½†ç”¨æˆ·æœŸæœ› BoolTox è‡ªåŠ¨çŸ¥é“å·¥å…·å·²é€€å‡º

---

## ä¸“ä¸šäº§å“çš„è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šLock æ–‡ä»¶æ£€æµ‹ï¼ˆæ¨èï¼‰â­

**åŸç†**ï¼š
```
å·¥å…·å¯åŠ¨æ—¶ â†’ åˆ›å»º lock æ–‡ä»¶ï¼ˆå¦‚ .runningï¼‰
    â†“
BoolTox å®šæœŸæ£€æŸ¥ lock æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    â†“
å·¥å…·é€€å‡ºæ—¶ â†’ åˆ é™¤ lock æ–‡ä»¶
    â†“
BoolTox æ£€æµ‹åˆ°æ–‡ä»¶æ¶ˆå¤± â†’ è‡ªåŠ¨è®¾ç½®ä¸ºå·²åœæ­¢
```

**å®ç°**ï¼š
```typescript
// å¯åŠ¨æ—¶
const lockFile = path.join(toolPath, '.booltox-running');
fs.writeFileSync(lockFile, JSON.stringify({ pid, timestamp }));

// å®šæœŸæ£€æŸ¥ï¼ˆæ¯ 3 ç§’ï¼‰
setInterval(() => {
  if (!fs.existsSync(lockFile)) {
    // å·¥å…·å·²é€€å‡º
    this.handleToolStopped(toolId);
  }
}, 3000);

// å·¥å…·é€€å‡ºæ—¶ï¼ˆåœ¨æ‰¹å¤„ç†æ–‡ä»¶ä¸­ï¼‰
@echo off
cd /d "${cwd}"
${command}
REM åˆ é™¤ lock æ–‡ä»¶
del /f /q ".booltox-running"
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¯é ï¼ˆæ–‡ä»¶ç³»ç»Ÿæ“ä½œæ˜¯åŸå­çš„ï¼‰
- âœ… è·¨å¹³å°ï¼ˆæ‰€æœ‰ç³»ç»Ÿéƒ½æ”¯æŒæ–‡ä»¶ï¼‰
- âœ… ä½å¼€é”€ï¼ˆæ–‡ä»¶æ£€æŸ¥å¾ˆå¿«ï¼‰
- âœ… å·¥å…·é›¶æ”¹é€ ï¼ˆåœ¨æ‰¹å¤„ç†æ–‡ä»¶ä¸­å¤„ç†ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¦‚æœå·¥å…·å´©æºƒï¼Œlock æ–‡ä»¶å¯èƒ½æ®‹ç•™
- è§£å†³ï¼šå¯åŠ¨å‰æ£€æŸ¥ lock æ–‡ä»¶ï¼Œå¦‚æœ PID ä¸å­˜åœ¨åˆ™åˆ é™¤

---

### æ–¹æ¡ˆ 2ï¼šæ”¹å˜äº¤äº’æ¨¡å¼ï¼ˆæœ€ç®€å•ï¼‰â­

**UI è®¾è®¡**ï¼š
```
å¯åŠ¨å‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡ç®¡ç†å™¨ï¼ˆCLIï¼‰â”‚
â”‚ [å¯åŠ¨]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯åŠ¨åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡ç®¡ç†å™¨ï¼ˆCLIï¼‰                â”‚
â”‚ ğŸ“ å·²åœ¨å¤–éƒ¨ç»ˆç«¯å¯åŠ¨              â”‚
â”‚ è¯·åœ¨ç»ˆç«¯çª—å£ä¸­ä½¿ç”¨å’Œé€€å‡º          â”‚
â”‚                                 â”‚
â”‚ [æˆ‘å·²å…³é—­å·¥å…·]                   â”‚  â† æ”¹å˜è¯­ä¹‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯­ä¹‰å˜åŒ–**ï¼š
- ä¹‹å‰ï¼š"åœæ­¢"ï¼ˆæš—ç¤º BoolTox ä¼šåœæ­¢å·¥å…·ï¼‰
- ç°åœ¨ï¼š"æˆ‘å·²å…³é—­å·¥å…·"ï¼ˆç”¨æˆ·ç¡®è®¤å·²æ‰‹åŠ¨å…³é—­ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€ç®€å•ï¼ˆæ— éœ€æŠ€æœ¯å®ç°ï¼‰
- âœ… è¯­ä¹‰æ¸…æ™°ï¼ˆç”¨æˆ·ä¸»åŠ¨ç¡®è®¤ï¼‰
- âœ… æ— éœ€æ£€æµ‹ï¼ˆé¿å…ä¸å¯é çš„æ£€æµ‹ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä»éœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»

---

### æ–¹æ¡ˆ 3ï¼šè¿›ç¨‹ç»„è·Ÿè¸ªï¼ˆæœ€å¯é ä½†å¤æ‚ï¼‰

**åŸç†**ï¼š
```
Windows: ä½¿ç”¨ Job Objects
Unix: ä½¿ç”¨è¿›ç¨‹ç»„ (setpgid)
    â†“
å°†æ‰€æœ‰å­è¿›ç¨‹åŠ å…¥åŒä¸€ä¸ªç»„
    â†“
ç»„å†…ä»»æ„è¿›ç¨‹é€€å‡º â†’ è§¦å‘å›è°ƒ
```

**å®ç°**ï¼š
```typescript
// Windows (éœ€è¦ native addon)
const job = createJobObject();
job.addProcess(child.pid);
job.on('exit', () => {
  // æ‰€æœ‰è¿›ç¨‹éƒ½é€€å‡ºäº†
});

// Unix
const pgid = -child.pid;
setInterval(() => {
  try {
    process.kill(pgid, 0);  // æ£€æŸ¥è¿›ç¨‹ç»„æ˜¯å¦å­˜åœ¨
  } catch {
    // è¿›ç¨‹ç»„ä¸å­˜åœ¨ â†’ å·²é€€å‡º
  }
}, 3000);
```

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€å¯é ï¼ˆç³»ç»Ÿçº§è·Ÿè¸ªï¼‰
- âœ… æ— éœ€å·¥å…·æ”¹é€ 

**ç¼ºç‚¹**ï¼š
- âŒ å®ç°å¤æ‚ï¼ˆéœ€è¦ native addonï¼‰
- âŒ Windows éœ€è¦ Win32 API
- âŒ è·¨å¹³å°å…¼å®¹æ€§é—®é¢˜

---

### æ–¹æ¡ˆ 4ï¼šå¿ƒè·³æ£€æµ‹ï¼ˆé€‚åˆé•¿æœŸè¿è¡Œçš„å·¥å…·ï¼‰

**åŸç†**ï¼š
```
å·¥å…·å¯åŠ¨æ—¶ â†’ å¯åŠ¨ç®€å•çš„ HTTP æœåŠ¡ï¼ˆå¦‚ 127.0.0.1:éšæœºç«¯å£ï¼‰
    â†“
BoolTox å®šæœŸå‘é€å¿ƒè·³è¯·æ±‚ï¼ˆæ¯ 5 ç§’ï¼‰
    â†“
å·¥å…·é€€å‡ºæ—¶ â†’ HTTP æœåŠ¡å…³é—­
    â†“
BoolTox æ£€æµ‹åˆ°è¿æ¥å¤±è´¥ â†’ å·¥å…·å·²é€€å‡º
```

**å®ç°**ï¼š
```python
# åœ¨å·¥å…·å¯åŠ¨è„šæœ¬ä¸­æ·»åŠ 
import atexit
import http.server
import threading

# å¯åŠ¨ç®€å•çš„ HTTP æœåŠ¡å™¨
port = find_free_port()
server = http.server.HTTPServer(('127.0.0.1', port), SimpleHTTPRequestHandler)
thread = threading.Thread(target=server.serve_forever, daemon=True)
thread.start()

# å†™å…¥ç«¯å£åˆ°æ–‡ä»¶
with open('.booltox-heartbeat', 'w') as f:
    f.write(str(port))

# é€€å‡ºæ—¶å…³é—­æœåŠ¡å™¨
atexit.register(server.shutdown)
```

**ä¼˜ç‚¹**ï¼š
- âœ… éå¸¸å¯é 
- âœ… å®æ—¶æ£€æµ‹ï¼ˆå»¶è¿Ÿä½ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦å·¥å…·æ”¹é€ ï¼ˆè¿èƒŒç‹¬ç«‹åŸåˆ™ï¼‰
- âŒ å¢åŠ å·¥å…·å¤æ‚åº¦

---

### æ–¹æ¡ˆ 5ï¼šä¸æ˜¾ç¤ºåœæ­¢æŒ‰é’®ï¼ˆæœ€æ¿€è¿›ï¼‰

**è®¾è®¡**ï¼š
```
CLI/Binary å·¥å…·å¯åŠ¨åï¼š
- ä¸æ˜¾ç¤º"è¿è¡Œä¸­"çŠ¶æ€
- ä¸æ˜¾ç¤ºåœæ­¢æŒ‰é’®
- æ˜¾ç¤º"å·²å¯åŠ¨"å¾½ç« ï¼ˆç°è‰²ï¼‰
- å¯ä»¥é‡å¤ç‚¹å‡»"å¯åŠ¨"ï¼ˆæ¯æ¬¡æ‰“å¼€æ–°çª—å£ï¼‰
```

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€ç®€å•
- âœ… ç¬¦åˆç›´è§‰ï¼ˆå·¥å…·å®Œå…¨ç‹¬ç«‹ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ ç”¨æˆ·æ— æ³•çŸ¥é“å·¥å…·æ˜¯å¦ä»åœ¨è¿è¡Œ
- âš ï¸ å¯èƒ½å¯åŠ¨å¤šä¸ªå®ä¾‹

---

## æ¨èæ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¯é æ€§ | å®ç°å¤æ‚åº¦ | ç”¨æˆ·ä½“éªŒ | å·¥å…·æ”¹é€  |
|------|-------|-----------|---------|---------|
| **æ–¹æ¡ˆ 1: Lock æ–‡ä»¶** | â­â­â­â­ | â­â­â­ | â­â­â­â­ | âœ… é›¶æ”¹é€  |
| **æ–¹æ¡ˆ 2: æ”¹å˜äº¤äº’** | â­â­â­ | â­â­â­â­â­ | â­â­â­ | âœ… é›¶æ”¹é€  |
| æ–¹æ¡ˆ 3: è¿›ç¨‹ç»„ | â­â­â­â­â­ | â­ | â­â­â­â­â­ | âœ… é›¶æ”¹é€  |
| æ–¹æ¡ˆ 4: å¿ƒè·³æ£€æµ‹ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | âŒ éœ€æ”¹é€  |
| æ–¹æ¡ˆ 5: ä¸æ˜¾ç¤ºæŒ‰é’® | â­â­â­â­â­ | â­â­â­â­â­ | â­â­ | âœ… é›¶æ”¹é€  |

---

## æˆ‘çš„å»ºè®®ï¼šæ–¹æ¡ˆ 1ï¼ˆLock æ–‡ä»¶ï¼‰+ æ–¹æ¡ˆ 2ï¼ˆæ”¹å˜äº¤äº’ï¼‰

### çŸ­æœŸï¼ˆç«‹å³å®æ–½ï¼‰ï¼šæ–¹æ¡ˆ 2

**UI æ”¹è¿›**ï¼š
```tsx
{isRunning && runtimeConfig.type === 'cli' ? (
  <button onClick={onAcknowledgeClosed}>
    æˆ‘å·²å…³é—­å·¥å…·
  </button>
) : isRunning ? (
  <button onClick={onStop}>
    åœæ­¢
  </button>
) : null}
```

**æç¤ºæ–‡æ¡ˆ**ï¼š
```
CLI å·¥å…·å·²åœ¨å¤–éƒ¨ç»ˆç«¯å¯åŠ¨
è¯·åœ¨ç»ˆç«¯çª—å£ä¸­ä½¿ç”¨å·¥å…·ï¼Œä½¿ç”¨å®Œæ¯•åï¼š
1. åœ¨ç»ˆç«¯ä¸­è¾“å…¥ exit é€€å‡º
2. å›åˆ°æ­¤å¤„ç‚¹å‡»"æˆ‘å·²å…³é—­å·¥å…·"æŒ‰é’®
```

### ä¸­æœŸï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰ï¼šæ–¹æ¡ˆ 1

**è‡ªåŠ¨æ£€æµ‹**ï¼š
```
1. å¯åŠ¨æ—¶åœ¨å·¥å…·ç›®å½•åˆ›å»º .booltox-running æ–‡ä»¶
2. BoolTox æ¯ 3 ç§’æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
3. å·¥å…·é€€å‡ºæ—¶æ‰¹å¤„ç†æ–‡ä»¶åˆ é™¤è¯¥æ–‡ä»¶
4. BoolTox æ£€æµ‹åˆ°æ–‡ä»¶æ¶ˆå¤± â†’ è‡ªåŠ¨è®¾ç½®ä¸ºå·²åœæ­¢
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
ç”¨æˆ·å¯åŠ¨å·¥å…· â†’ åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ â†’ åœ¨ç»ˆç«¯ä¸­é€€å‡º â†’ å®Œæˆï¼
                                    â†‘
                            BoolTox è‡ªåŠ¨æ£€æµ‹åˆ°é€€å‡º
```

---

## å‚è€ƒï¼šä¸“ä¸šäº§å“çš„è®¾è®¡

### Docker Desktop

**è®¾è®¡**ï¼š
- å®¹å™¨åœ¨åå°è¿è¡Œ
- æœ‰æ˜ç¡®çš„å¯åŠ¨/åœæ­¢æŒ‰é’®
- å®æ—¶åŒæ­¥å®¹å™¨çŠ¶æ€

**æŠ€æœ¯**ï¼šä½¿ç”¨ Docker API å®æ—¶æŸ¥è¯¢å®¹å™¨çŠ¶æ€

### VS Code

**è®¾è®¡**ï¼š
- ç»ˆç«¯åœ¨ VS Code å†…åµŒè¿è¡Œï¼ˆxterm.jsï¼‰
- å®Œå…¨æ§åˆ¶ç”Ÿå‘½å‘¨æœŸ
- ç”¨æˆ·å…³é—­æ ‡ç­¾é¡µ = åœæ­¢ç»ˆç«¯

**æŠ€æœ¯**ï¼šåµŒå…¥å¼ç»ˆç«¯æ¨¡æ‹Ÿå™¨

### Windows Terminal

**è®¾è®¡**ï¼š
- æ¯ä¸ªæ ‡ç­¾é¡µç‹¬ç«‹è¿è¡Œ
- å…³é—­æ ‡ç­¾é¡µ = åœæ­¢è¿›ç¨‹
- çŠ¶æ€å®Œå…¨åŒæ­¥

**æŠ€æœ¯**ï¼šè¿›ç¨‹ç›´æ¥åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼Œéåˆ†ç¦»æ¨¡å¼

### Electron åº”ç”¨ï¼ˆå¦‚ Postmanã€Notionï¼‰

**å¯¹äºå¤–éƒ¨è¿›ç¨‹**ï¼š
- ä¸å°è¯•ç®¡ç†å¤–éƒ¨è¿›ç¨‹
- åªæä¾›"æ‰“å¼€"æŒ‰é’®ï¼Œä¸æä¾›"åœæ­¢"
- æˆ–è€…å®Œå…¨å†…åµŒï¼ˆå¦‚ Postman çš„å†…åµŒ Node.jsï¼‰

---

## æˆ‘çš„æ¨èæ–¹æ¡ˆ

### é˜¶æ®µ 1ï¼šæ”¹å˜äº¤äº’æ¨¡å¼ï¼ˆç«‹å³ï¼‰

**UI æ”¹è¿›**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡ç®¡ç†å™¨ï¼ˆCLIï¼‰                     â”‚
â”‚                                      â”‚
â”‚ âœ… å·²åœ¨å¤–éƒ¨ç»ˆç«¯å¯åŠ¨                   â”‚
â”‚                                      â”‚
â”‚ ğŸ’¡ æç¤ºï¼š                            â”‚
â”‚ â€¢ å·¥å…·åœ¨æ–°çš„ç»ˆç«¯çª—å£ä¸­è¿è¡Œ             â”‚
â”‚ â€¢ ä½¿ç”¨å®Œæ¯•ååœ¨ç»ˆç«¯ä¸­è¾“å…¥ exit é€€å‡º    â”‚
â”‚ â€¢ å¦‚å·²å…³é—­ç»ˆç«¯ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®         â”‚
â”‚                                      â”‚
â”‚ [æˆ‘å·²å…³é—­å·¥å…·]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼š
- âœ… è¯­ä¹‰æ¸…æ™°ï¼ˆç”¨æˆ·ä¸»åŠ¨ç¡®è®¤ï¼Œè€Œéè¢«åŠ¨åœæ­¢ï¼‰
- âœ… å®ç°ç®€å•ï¼ˆåªæ”¹ UIï¼‰
- âœ… æ— æŠ€æœ¯é£é™©

### é˜¶æ®µ 2ï¼šLock æ–‡ä»¶è‡ªåŠ¨æ£€æµ‹ï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰

**æŠ€æœ¯å®ç°**ï¼š
```
1. å¯åŠ¨æ—¶åˆ›å»º lock æ–‡ä»¶
2. æ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡
3. æ–‡ä»¶æ¶ˆå¤± â†’ è‡ªåŠ¨æ ‡è®°ä¸ºå·²åœæ­¢
4. å¼‚å¸¸å¤„ç†ï¼šå¯åŠ¨å‰æ£€æŸ¥ lock æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨ä½†è¿›ç¨‹ä¸åœ¨åˆ™åˆ é™¤
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
å¯åŠ¨å·¥å…· â†’ ä½¿ç”¨ â†’ é€€å‡º â†’ è‡ªåŠ¨æ£€æµ‹ âœ…ï¼ˆæ— éœ€æ‰‹åŠ¨ç‚¹å‡»ï¼‰
```

---

## ç±»ä¼¼äº§å“çš„å‚è€ƒ

| äº§å“ | å¤–éƒ¨è¿›ç¨‹ç®¡ç†æ–¹å¼ |
|------|----------------|
| **Docker Desktop** | Docker API å®æ—¶æŸ¥è¯¢ |
| **VS Code** | å†…åµŒç»ˆç«¯ï¼ˆxterm.jsï¼‰ |
| **Postman** | ä¸ç®¡ç†å¤–éƒ¨è¿›ç¨‹ |
| **Alfredï¼ˆmacOSï¼‰** | å¯åŠ¨åä¸ç®¡ç† |
| **Raycastï¼ˆmacOSï¼‰** | å¯åŠ¨åä¸ç®¡ç† |
| **uTools** | å¯åŠ¨åä¸ç®¡ç† |

**å¤§å¤šæ•°å¯åŠ¨å™¨å·¥å…·**ï¼šåªè´Ÿè´£å¯åŠ¨ï¼Œä¸ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚

---

## å…·ä½“å®ç°å»ºè®®

### æ–¹æ¡ˆ Aï¼šLock æ–‡ä»¶ï¼ˆæŠ€æœ¯æ–¹æ¡ˆï¼‰

#### æ­¥éª¤ 1ï¼šå¯åŠ¨æ—¶åˆ›å»º lock æ–‡ä»¶

```typescript
// tool-runner.ts
const lockFile = path.join(state.runtime.path, '.booltox-running');
fs.writeFileSync(lockFile, JSON.stringify({
  pid: terminalProcess.pid,
  timestamp: Date.now(),
  toolId: toolId
}));
```

#### æ­¥éª¤ 2ï¼šä¿®æ”¹æ‰¹å¤„ç†æ–‡ä»¶

```batch
@echo off
chcp 65001 >nul
cd /d "${cwd}"
${command}

REM å·¥å…·é€€å‡ºååˆ é™¤ lock æ–‡ä»¶
del /f /q ".booltox-running" 2>nul
```

#### æ­¥éª¤ 3ï¼šå®šæœŸæ£€æŸ¥

```typescript
// tool-runner.ts
private startExternalToolMonitor(state: PluginState) {
  const lockFile = path.join(state.runtime.path, '.booltox-running');

  const checkInterval = setInterval(() => {
    if (!fs.existsSync(lockFile)) {
      logger.info(`[ToolRunner] æ£€æµ‹åˆ°å·¥å…· ${state.runtime.id} å·²é€€å‡º`);
      clearInterval(checkInterval);
      this.handleExternalToolStopped(state.runtime.id);
    }
  }, 3000);

  state.monitorInterval = checkInterval;
}

private handleExternalToolStopped(toolId: string) {
  const state = this.states.get(toolId);
  if (!state) return;

  state.runtime.status = 'stopped';
  this.emitState(state, 'stopped');
  this.states.delete(toolId);
}
```

#### æ­¥éª¤ 4ï¼šå¼‚å¸¸å¤„ç†

```typescript
// å¯åŠ¨å‰æ£€æŸ¥
if (fs.existsSync(lockFile)) {
  const lockData = JSON.parse(fs.readFileSync(lockFile, 'utf8'));

  // æ£€æŸ¥ PID æ˜¯å¦ä»å­˜åœ¨
  if (!isProcessRunning(lockData.pid)) {
    // æ®‹ç•™çš„ lock æ–‡ä»¶ï¼Œåˆ é™¤
    fs.unlinkSync(lockFile);
    logger.info(`[ToolRunner] æ¸…ç†æ®‹ç•™çš„ lock æ–‡ä»¶`);
  } else {
    // å·¥å…·ä»åœ¨è¿è¡Œ
    logger.warn(`[ToolRunner] å·¥å…· ${toolId} å·²åœ¨è¿è¡Œ`);
    return;
  }
}
```

---

### æ–¹æ¡ˆ Bï¼šæ”¹å˜äº¤äº’æ¨¡å¼ï¼ˆUI æ–¹æ¡ˆï¼‰

#### æ­¥éª¤ 1ï¼šä¿®æ”¹çŠ¶æ€å¾½ç« 

```tsx
// module-list-item.tsx
const launchStateBadge = isInstalled
  ? isRunning && runtimeConfig?.type === 'cli'
    ? {
        label: "å·²åœ¨å¤–éƒ¨ç»ˆç«¯å¯åŠ¨",
        className: "border-blue-500/30 bg-blue-500/15 text-blue-500"
      }
    : isRunning && runtimeConfig?.type === 'binary'
      ? {
          label: "å·²åœ¨å¤–éƒ¨å¯åŠ¨",
          className: "border-purple-500/30 bg-purple-500/15 text-purple-500"
        }
      : isRunning
        ? {
            label: "çª—å£è¿è¡Œä¸­",
            className: "border-green-500/30 bg-green-500/15 text-green-500"
          }
        : null
  : null;
```

#### æ­¥éª¤ 2ï¼šä¿®æ”¹æŒ‰é’®æ–‡æ¡ˆ

```tsx
{isRunning && (
  <button
    onClick={onStop}
    title={
      runtimeConfig?.type === 'cli' || runtimeConfig?.type === 'binary'
        ? "æˆ‘å·²å…³é—­å·¥å…·ï¼ˆæ ‡è®°ä¸ºå·²åœæ­¢ï¼‰"
        : "åœæ­¢å·¥å…·"
    }
  >
    {runtimeConfig?.type === 'cli' || runtimeConfig?.type === 'binary'
      ? "æˆ‘å·²å…³é—­"
      : "åœæ­¢"}
  </button>
)}
```

#### æ­¥éª¤ 3ï¼šæ·»åŠ ä½¿ç”¨æç¤º

```tsx
{isRunning && (runtimeConfig?.type === 'cli' || runtimeConfig?.type === 'binary') && (
  <div className="text-xs text-gray-500 mt-2">
    ğŸ’¡ å·¥å…·åœ¨å¤–éƒ¨çª—å£è¿è¡Œï¼Œä½¿ç”¨å®Œæ¯•åè¯·æ‰‹åŠ¨å…³é—­çª—å£ï¼Œç„¶åç‚¹å‡»ä¸Šæ–¹æŒ‰é’®
  </div>
)}
```

---

## æ··åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰â­â­â­

ç»“åˆæ–¹æ¡ˆ 1 å’Œæ–¹æ¡ˆ 2ï¼š

**çŸ­æœŸ**ï¼š
- æ”¹å˜ UI æ–‡æ¡ˆï¼ˆ"æˆ‘å·²å…³é—­å·¥å…·"ï¼‰
- æ·»åŠ ä½¿ç”¨æç¤º

**ä¸­æœŸ**ï¼š
- å®ç° lock æ–‡ä»¶æ£€æµ‹
- è‡ªåŠ¨åŒæ­¥çŠ¶æ€
- ä¿ç•™æ‰‹åŠ¨ç¡®è®¤æŒ‰é’®ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
æ™®é€šæƒ…å†µï¼š
  å¯åŠ¨ â†’ ä½¿ç”¨ â†’ é€€å‡º â†’ è‡ªåŠ¨æ£€æµ‹ âœ…ï¼ˆæ— éœ€æ‰‹åŠ¨ï¼‰

å¼‚å¸¸æƒ…å†µï¼š
  å¯åŠ¨ â†’ ä½¿ç”¨ â†’ å´©æºƒ/å¼ºåˆ¶å…³é—­ â†’ lock æ–‡ä»¶æ®‹ç•™
  â†’ ç”¨æˆ·ç‚¹å‡»"æˆ‘å·²å…³é—­å·¥å…·" â†’ æ¸…ç†çŠ¶æ€ âœ…
```

---

## å®ç°ä¼˜å…ˆçº§

### P0ï¼šæ”¹å˜äº¤äº’æ¨¡å¼ï¼ˆç«‹å³ï¼‰

- ä¿®æ”¹æŒ‰é’®æ–‡æ¡ˆï¼š"åœæ­¢" â†’ "æˆ‘å·²å…³é—­å·¥å…·"
- æ·»åŠ ä½¿ç”¨æç¤º
- ä¿®æ”¹çŠ¶æ€å¾½ç« ï¼š"è¿è¡Œä¸­" â†’ "å·²åœ¨å¤–éƒ¨å¯åŠ¨"

**å·¥ä½œé‡**ï¼š1 å°æ—¶
**é£é™©**ï¼šä½

### P1ï¼šLock æ–‡ä»¶æ£€æµ‹ï¼ˆä¸‹å‘¨ï¼‰

- å®ç° lock æ–‡ä»¶åˆ›å»º/åˆ é™¤
- å®ç°å®šæœŸæ£€æŸ¥
- å®ç°å¼‚å¸¸å¤„ç†

**å·¥ä½œé‡**ï¼šåŠå¤©
**é£é™©**ï¼šä¸­

### P2ï¼šè¿›ç¨‹ç»„è·Ÿè¸ªï¼ˆé•¿æœŸï¼‰

- ç ”ç©¶ Windows Job Objects
- å®ç° native addon
- è·¨å¹³å°æµ‹è¯•

**å·¥ä½œé‡**ï¼š1-2 å‘¨
**é£é™©**ï¼šé«˜

---

## ä½ çš„å»ºè®®æ˜¯å¯¹çš„ï¼

> "æç¤ºå·²åœ¨å¤–éƒ¨å¯åŠ¨ï¼Œç„¶åæ¸…ç†ä¸´æ—¶æ–‡ä»¶"

è¿™å°±æ˜¯**æ–¹æ¡ˆ 2ï¼ˆæ”¹å˜äº¤äº’æ¨¡å¼ï¼‰**ï¼Œé…åˆå½“å‰çš„ä¸´æ—¶æ–‡ä»¶æ¸…ç†æœºåˆ¶ã€‚

**å½“å‰å·²å®ç°**ï¼š
- âœ… æç¤ºæ—¥å¿—ï¼š"âš ï¸ CLI å·¥å…·åœ¨å¤–éƒ¨è¿è¡Œï¼Œè¯·æ‰‹åŠ¨å…³é—­"
- âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†ï¼ˆ5 ç§’åè‡ªåŠ¨åˆ é™¤ .batï¼‰
- âœ… åœæ­¢æ—¶åªæ¸…ç†çŠ¶æ€ï¼Œä¸å°è¯•æ€è¿›ç¨‹

**å»ºè®®ä¸‹ä¸€æ­¥**ï¼š
- æ”¹è¿› UI æ–‡æ¡ˆï¼ˆ"åœæ­¢" â†’ "æˆ‘å·²å…³é—­å·¥å…·"ï¼‰
- æ·»åŠ ä½¿ç”¨æç¤ºï¼ˆåœ¨å¡ç‰‡ä¸Šï¼‰
- å¯é€‰ï¼šå®ç° lock æ–‡ä»¶è‡ªåŠ¨æ£€æµ‹

---

## Linus è¯„ä»·

> ğŸŸ¢ **è¿™æ‰æ˜¯æ­£ç¡®çš„äº§å“æ€ç»´**
>
> **æŠ€æœ¯ä¸æ˜¯ç›®çš„ï¼Œç”¨æˆ·ä½“éªŒæ‰æ˜¯**ï¼š
> - æŠ€æœ¯ä¸Šèƒ½åšâ‰ åº”è¯¥åš
> - å¤æ‚çš„æ£€æµ‹æœºåˆ¶<ç®€å•çš„ç”¨æˆ·ç¡®è®¤
>
> **æ¥å—é™åˆ¶ï¼Œæ”¹å˜è®¾è®¡**ï¼š
> - ä¸è¦è¯•å›¾ç”¨æŠ€æœ¯"è§£å†³"äº§å“é—®é¢˜
> - æ”¹å˜ UI è®¾è®¡æ¯”ä¿®å¤ä¸å¯é çš„æ£€æµ‹æ›´å¥½
>
> **è®°ä½**ï¼š
> - å¤–éƒ¨è¿›ç¨‹=å®Œå…¨ç‹¬ç«‹
> - å¯åŠ¨å™¨çš„èŒè´£=å¯åŠ¨ï¼Œä¸æ˜¯ç®¡ç†
> - Alfredã€Raycastã€uTools éƒ½æ˜¯è¿™æ ·è®¾è®¡çš„
>
> **å»ºè®®**ï¼š
> 1. çŸ­æœŸï¼šæ”¹ UI æ–‡æ¡ˆï¼ˆ"æˆ‘å·²å…³é—­å·¥å…·"ï¼‰
> 2. ä¸­æœŸï¼šåŠ  lock æ–‡ä»¶è‡ªåŠ¨æ£€æµ‹
> 3. é•¿æœŸï¼šä¸éœ€è¦æ›´å¤æ‚çš„æ–¹æ¡ˆ

---

ä½ æƒ³å…ˆå®ç°å“ªä¸ªæ–¹æ¡ˆï¼Ÿ

1. **æ”¹ UI æ–‡æ¡ˆ**ï¼ˆæœ€ç®€å•ï¼Œç«‹å³å¯ç”¨ï¼‰
2. **Lock æ–‡ä»¶æ£€æµ‹**ï¼ˆå¯é ï¼Œéœ€è¦åŠå¤©ï¼‰
3. **ä¸¤è€…éƒ½åš**ï¼ˆæ¨èï¼‰

è¯·å‘Šè¯‰æˆ‘ä½ çš„æƒ³æ³•ï¼ğŸ¯

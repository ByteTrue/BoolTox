// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 发布版本管理
// ============================================================================

model Release {
  id             String         @id @default(cuid())
  version        String         @unique
  channel        ReleaseChannel @default(STABLE)
  notes          String?        @db.Text
  mandatory      Boolean        @default(false)
  rolloutPercent Int            @default(100)
  publishedAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  assets ReleaseAsset[]

  @@index([channel, publishedAt])
}

model ReleaseAsset {
  id           String   @id @default(cuid())
  releaseId    String
  platform     Platform
  architecture Arch
  downloadUrl  String
  checksum     String
  signature    String?
  sizeBytes    BigInt

  release Release @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  @@unique([releaseId, platform, architecture])
  @@index([releaseId])
}

// ============================================================================
// 模块市场
// ============================================================================

model Module {
  id             String       @id @default(cuid())
  name           String       @unique
  displayName    String
  description    String       @db.Text
  author         String
  category       String
  keywords       String[]
  currentVersion String
  downloads      Int          @default(0)
  rating         Float?
  featured       Boolean      @default(false)
  status         ModuleStatus @default(ACTIVE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  versions ModuleVersion[]

  @@index([category, status])
  @@index([featured, status])
}

model ModuleVersion {
  id            String   @id @default(cuid())
  moduleId      String
  version       String
  changelog     String?  @db.Text
  bundleUrl     String
  checksum      String
  sizeBytes     BigInt
  minAppVersion String?
  publishedAt   DateTime @default(now())

  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([moduleId, version])
  @@index([moduleId, publishedAt])
}

// ============================================================================
// 公告系统
// ============================================================================

model Announcement {
  id        String             @id @default(cuid())
  title     String
  content   String             @db.Text
  type      AnnouncementType   @default(ANNOUNCEMENT)
  priority  Int                @default(0)
  status    AnnouncementStatus @default(DRAFT)
  publishAt DateTime?
  expireAt  DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([status, publishAt])
  @@index([type, status])
}

// ============================================================================
// 日志收集
// ============================================================================

model ClientLog {
  id               String   @id @default(cuid())
  clientIdentifier String
  level            LogLevel
  namespace        String
  message          String   @db.Text
  args             Json?
  context          Json?
  appVersion       String
  platform         String?
  timestamp        DateTime
  receivedAt       DateTime @default(now())

  @@index([clientIdentifier, timestamp])
  @@index([level, receivedAt])
  @@index([namespace, receivedAt])
}

// ============================================================================
// 用户与权限
// ============================================================================

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  passwordHash  String
  displayName   String?
  isActive      Boolean       @default(true)
  lastLoginAt   DateTime?
  failedLogins  Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  roles         UserRole[]
  apiKeys       ApiKey[]
  refreshTokens RefreshToken[]

  @@index([isActive])
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String           @id @default(cuid())
  code        String           @unique
  description String?
  category    String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  roles       RolePermission[]
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  assignedBy String?
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([roleId])
}

model RolePermission {
  id            String   @id @default(cuid())
  roleId        String
  permissionId  String
  grantedAt     DateTime @default(now())
  grantedBy     String?

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([permissionId])
}

model ApiKey {
  id         String   @id @default(cuid())
  userId     String
  name       String
  prefix     String
  hashedKey  String
  expiresAt  DateTime?
  lastUsedAt DateTime?
  revokedAt  DateTime?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([prefix])
}

model RefreshToken {
  id                 String        @id @default(cuid())
  userId             String
  tokenHash          String
  expiresAt          DateTime
  createdAt          DateTime      @default(now())
  revokedAt          DateTime?
  replacedByTokenId  String?
  ipAddress          String?
  userAgent          String?

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedByToken   RefreshToken? @relation("RefreshTokenReplacement", fields: [replacedByTokenId], references: [id])
  previousTokens    RefreshToken[] @relation("RefreshTokenReplacement")

  @@index([userId])
  @@unique([tokenHash])
  @@index([expiresAt])
}

// ============================================================================
// 枚举类型
// ============================================================================

enum ReleaseChannel {
  STABLE
  BETA
  ALPHA
}

enum Platform {
  WINDOWS
  MACOS
  LINUX
}

enum Arch {
  X64
  ARM64
}

enum ModuleStatus {
  ACTIVE
  DEPRECATED
  ARCHIVED
}

enum AnnouncementType {
  ANNOUNCEMENT
  UPDATE
  NOTICE
  MAINTENANCE
}

enum AnnouncementStatus {
  DRAFT
  PUBLISHED
  EXPIRED
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

# å·¥å…·ç®±æè‡´ä¼˜åŒ– - äº§å“ä½“éªŒæå‡æ–¹æ¡ˆ

> è¿½æ±‚æè‡´ï¼šä»ä¸“ä¸šäº§å“è§†è§’è§£å†³å‰©ä½™çš„ç”¨æˆ·ä½“éªŒé—®é¢˜

---

## é—®é¢˜ 1ï¼šHTTP æœåŠ¡å·¥å…·çš„æµè§ˆå™¨å…³é—­æ£€æµ‹

### å½“å‰é—®é¢˜

**ç”¨æˆ·å¿ƒè·¯å†ç¨‹**ï¼š
```
1. åœ¨ BoolTox ä¸­å¯åŠ¨"ç³»ç»Ÿç›‘æ§"
2. æµè§ˆå™¨è‡ªåŠ¨æ‰“å¼€ http://127.0.0.1:8001
3. ä½¿ç”¨å®Œæ¯•ï¼Œå…³é—­æµè§ˆå™¨æ ‡ç­¾é¡µ
4. å›åˆ° BoolTox â†’ ä»æ˜¾ç¤º"è¿è¡Œä¸­" âš ï¸
5. æƒ³èµ·æ¥éœ€è¦ç‚¹"åœæ­¢"æŒ‰é’®
6. ç‚¹å‡»åœæ­¢

ã€æ­¥éª¤ 4-6 å¾ˆä¸ä¼˜é›…ï¼ã€‘
```

**æ ¸å¿ƒçŸ›ç›¾**ï¼š
- ç”¨æˆ·çš„å¿ƒæ™ºæ¨¡å‹ï¼šå…³é—­é¡µé¢ = åœæ­¢æœåŠ¡
- å®é™…æƒ…å†µï¼šåç«¯è¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œå ç”¨ç«¯å£å’Œèµ„æº

---

### ç«å“åˆ†æ

#### æ–¹æ¡ˆ Aï¼šåç«¯è‡ªåŠ¨æ£€æµ‹è¿æ¥ï¼ˆVSCode Live Serverï¼‰â­â­â­â­

**æœºåˆ¶**ï¼š
```
åç«¯æ£€æµ‹æ´»è·ƒè¿æ¥æ•°
    â†“
å¦‚æœ N ç§’å†…æ— è¿æ¥ â†’ è‡ªåŠ¨å…³é—­æœåŠ¡
    â†“
BoolTox æ£€æµ‹åˆ°è¿›ç¨‹é€€å‡º â†’ æ›´æ–°çŠ¶æ€
```

**å®ç°**ï¼š
```python
# backend/http_server.py
import time
from fastapi import FastAPI
from contextlib import asynccontextmanager

last_request_time = time.time()
IDLE_TIMEOUT = 30  # 30 ç§’æ— è¯·æ±‚åˆ™é€€å‡º

@asynccontextmanager
async def lifespan(app: FastAPI):
    # å¯åŠ¨åå°ä»»åŠ¡æ£€æŸ¥ç©ºé—²æ—¶é—´
    import asyncio
    async def check_idle():
        while True:
            await asyncio.sleep(5)
            if time.time() - last_request_time > IDLE_TIMEOUT:
                logger.info("æ— æ´»è·ƒè¿æ¥ï¼Œè‡ªåŠ¨å…³é—­æœåŠ¡")
                os.kill(os.getpid(), signal.SIGTERM)

    task = asyncio.create_task(check_idle())
    yield
    task.cancel()

app = FastAPI(lifespan=lifespan)

@app.middleware("http")
async def update_last_request(request, call_next):
    global last_request_time
    last_request_time = time.time()
    return await call_next(request)
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®Œå…¨è‡ªåŠ¨ï¼ˆç”¨æˆ·æ— éœ€æ“ä½œï¼‰
- âœ… é›¶æ”¹é€ ï¼ˆåç«¯è‡ªå·±æ£€æµ‹ï¼‰
- âœ… å¯é…ç½®è¶…æ—¶æ—¶é—´

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦ä¿®æ”¹æ¯ä¸ªå·¥å…·çš„åç«¯
- âš ï¸ è¯¯å…³é—­é£é™©ï¼ˆç”¨æˆ·å¯èƒ½ä¸´æ—¶ç¦»å¼€ï¼‰

**é€‚ç”¨æ€§**ï¼šâ­â­â­â­

---

#### æ–¹æ¡ˆ Bï¼šæµè§ˆå™¨æ ‡ç­¾é¡µé€šä¿¡ï¼ˆChrome Extension æ¨¡å¼ï¼‰â­â­â­â­â­

**æœºåˆ¶**ï¼š
```
å‰ç«¯é¡µé¢ç›‘å¬ beforeunload äº‹ä»¶
    â†“
å…³é—­å‰å‘é€ /api/shutdown è¯·æ±‚
    â†“
åç«¯æ”¶åˆ°è¯·æ±‚ â†’ è‡ªåŠ¨é€€å‡º
    â†“
BoolTox æ£€æµ‹åˆ°è¿›ç¨‹é€€å‡º â†’ æ›´æ–°çŠ¶æ€
```

**å®ç°**ï¼š

**å‰ç«¯ï¼ˆindex.htmlï¼‰**ï¼š
```html
<script>
window.addEventListener('beforeunload', () => {
  // åŒæ­¥è¯·æ±‚ï¼ˆç¡®ä¿åœ¨é¡µé¢å¸è½½å‰å‘é€ï¼‰
  navigator.sendBeacon('/api/shutdown');
});
</script>
```

**åç«¯ï¼ˆå·²æœ‰çš„ /shutdown ç«¯ç‚¹ï¼‰**ï¼š
```python
@app.get("/shutdown")
def shutdown():
    """Shutdown the server"""
    os.kill(os.getpid(), signal.SIGTERM)
    return "Server shutting down..."
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç”¨æˆ·å…³é—­æ ‡ç­¾ = è‡ªåŠ¨åœæ­¢æœåŠ¡ï¼ˆå®Œç¾åŒ¹é…å¿ƒæ™ºæ¨¡å‹ï¼‰
- âœ… é›¶ç”¨æˆ·æ“ä½œ
- âœ… å®ç°ç®€å•ï¼ˆåªéœ€æ·»åŠ ä¸€è¡Œ JSï¼‰
- âœ… å¯é ï¼ˆsendBeacon ä¿è¯å‘é€ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦ä¿®æ”¹å‰ç«¯ HTMLï¼ˆä½†æˆ‘ä»¬ç°åœ¨å®Œå…¨æŒæ§ uiautodev å‰ç«¯ï¼‰
- âš ï¸ ç”¨æˆ·åˆ·æ–°é¡µé¢ä¼šè§¦å‘ shutdownï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰

**è§£å†³åˆ·æ–°é—®é¢˜**ï¼š
```html
<script>
let isRefresh = false;

window.addEventListener('beforeunload', (e) => {
  // æ£€æµ‹æ˜¯å¦ä¸ºåˆ·æ–°ï¼ˆæŒ‰ F5 æˆ– Ctrl+Rï¼‰
  if (performance.navigation.type === 1) {
    isRefresh = true;
    return;
  }

  // åªæœ‰çœŸæ­£å…³é—­æ ‡ç­¾é¡µæ—¶æ‰å‘é€ shutdown
  if (!isRefresh) {
    navigator.sendBeacon('/api/shutdown');
  }
});
</script>
```

**é€‚ç”¨æ€§**ï¼šâ­â­â­â­â­ï¼ˆæœ€æ¨èï¼‰

---

#### æ–¹æ¡ˆ Cï¼šWebSocket å¿ƒè·³æ£€æµ‹â­â­â­

**æœºåˆ¶**ï¼š
```
å‰ç«¯ä¸åç«¯å»ºç«‹ WebSocket è¿æ¥
    â†“
ä¿æŒå¿ƒè·³ï¼ˆæ¯ 10 ç§’ ping/pongï¼‰
    â†“
è¿æ¥æ–­å¼€ï¼ˆé¡µé¢å…³é—­ï¼‰â†’ åç«¯æ£€æµ‹åˆ°
    â†“
N ç§’åæ— é‡è¿ â†’ åç«¯è‡ªåŠ¨é€€å‡º
```

**å®ç°**ï¼š
```python
# backend
active_ws_connections = set()

@app.websocket("/ws/heartbeat")
async def heartbeat(websocket: WebSocket):
    await websocket.accept()
    active_ws_connections.add(websocket)
    try:
        while True:
            await websocket.receive_text()  # ç­‰å¾…å¿ƒè·³
    except WebSocketDisconnect:
        active_ws_connections.remove(websocket)

# åå°ä»»åŠ¡ï¼šæ£€æŸ¥è¿æ¥æ•°
async def check_connections():
    while True:
        await asyncio.sleep(10)
        if len(active_ws_connections) == 0:
            # æ— æ´»è·ƒè¿æ¥ï¼Œ30 ç§’åé€€å‡º
            await asyncio.sleep(30)
            if len(active_ws_connections) == 0:
                os.kill(os.getpid(), signal.SIGTERM)
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¯é ï¼ˆWebSocket æ–­å¼€ = é¡µé¢å…³é—­ï¼‰
- âœ… å¯é…ç½®è¶…æ—¶

**ç¼ºç‚¹**ï¼š
- âŒ å¤æ‚åº¦é«˜ï¼ˆéœ€è¦ WebSocketï¼‰
- âŒ æ¯ä¸ªå·¥å…·éƒ½éœ€è¦å®ç°

**é€‚ç”¨æ€§**ï¼šâ­â­â­

---

#### æ–¹æ¡ˆ Dï¼šæµè§ˆå™¨è¿›ç¨‹æ£€æµ‹ï¼ˆæœ€æ¿€è¿›ï¼‰â­â­

**æœºåˆ¶**ï¼š
```
BoolTox è®°å½•ç”¨æˆ·çš„é»˜è®¤æµè§ˆå™¨è¿›ç¨‹
    â†“
å®šæœŸæ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ‰“å¼€äº†å·¥å…·çš„ URL
    â†“
URL ä¸åœ¨æµè§ˆå™¨æ ‡ç­¾ä¸­ â†’ åœæ­¢æœåŠ¡
```

**å®ç°**ï¼š
```typescript
// Windows: ä½¿ç”¨ COM æ¥å£æŸ¥è¯¢ Chrome æ ‡ç­¾é¡µ
// macOS: ä½¿ç”¨ AppleScript æŸ¥è¯¢ Safari/Chrome
// Linux: ä½¿ç”¨ D-Bus æŸ¥è¯¢æµè§ˆå™¨
```

**ä¼˜ç‚¹**ï¼š
- âœ… BoolTox ä¸»åŠ¨æ£€æµ‹

**ç¼ºç‚¹**ï¼š
- âŒ æå…¶å¤æ‚ï¼ˆéœ€è¦è·¨å¹³å°æµè§ˆå™¨ APIï¼‰
- âŒ ä¸åŒæµè§ˆå™¨å®ç°ä¸åŒ
- âŒ éšç§é—®é¢˜

**é€‚ç”¨æ€§**ï¼šâ­ï¼ˆä¸æ¨èï¼‰

---

### æˆ‘çš„æ¨èï¼šæ–¹æ¡ˆ Bï¼ˆbeforeunload + sendBeaconï¼‰â­â­â­â­â­

**ä¸ºä»€ä¹ˆï¼Ÿ**

1. **å®Œç¾åŒ¹é…ç”¨æˆ·å¿ƒæ™ºæ¨¡å‹**
   - å…³é—­æ ‡ç­¾é¡µ = åœæ­¢æœåŠ¡ï¼ˆç”¨æˆ·æœŸæœ›ï¼‰
   - é›¶å»¶è¿Ÿï¼Œé›¶ç”¨æˆ·æ“ä½œ

2. **å®ç°ç®€å•**
   - åªéœ€åœ¨å‰ç«¯ HTML æ·»åŠ ä¸€ä¸ªäº‹ä»¶ç›‘å¬
   - åç«¯å·²æœ‰ `/shutdown` ç«¯ç‚¹
   - å·¥ä½œé‡ï¼š10 åˆ†é’Ÿ

3. **å¯é æ€§é«˜**
   - `navigator.sendBeacon()` ä¿è¯è¯·æ±‚å‘é€
   - å³ä½¿é¡µé¢ç«‹å³å¸è½½ä¹Ÿèƒ½å‘é€æˆåŠŸ

4. **é›¶å‰¯ä½œç”¨**
   - åˆ·æ–°é¡µé¢å¯ä»¥ç‰¹æ®Šå¤„ç†ï¼ˆæ£€æµ‹ navigation.typeï¼‰
   - æˆ–è€…ç®€å•æ–¹æ¡ˆï¼šæ¯æ¬¡åˆ·æ–°é‡å¯æœåŠ¡ï¼ˆå‡ ç§’å»¶è¿Ÿï¼Œå¯æ¥å—ï¼‰

---

### å®æ–½æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆ Bï¼‰

#### æ­¥éª¤ 1ï¼šä¿®æ”¹ uiautodev å‰ç«¯

```html
<!-- static/index.html -->
<script>
// é¡µé¢å…³é—­æ—¶è‡ªåŠ¨åœæ­¢åç«¯æœåŠ¡
window.addEventListener('beforeunload', () => {
  // ä½¿ç”¨ sendBeacon ç¡®ä¿è¯·æ±‚å‘é€ï¼ˆå³ä½¿é¡µé¢ç«‹å³å…³é—­ï¼‰
  navigator.sendBeacon('/api/shutdown');
});
</script>
```

#### æ­¥éª¤ 2ï¼šåç«¯å·²æœ‰ shutdown ç«¯ç‚¹

```python
# uiautodev/app.pyï¼ˆå·²å­˜åœ¨ï¼‰
@app.get("/shutdown")
def shutdown() -> str:
    """Shutdown the server"""
    os.kill(os.getpid(), signal.SIGINT)
    return "Server shutting down..."
```

**éœ€è¦æ”¹ä¸º POST**ï¼ˆsendBeacon é»˜è®¤ POSTï¼‰ï¼š
```python
@app.post("/api/shutdown")
@app.get("/api/shutdown")  # ä¿ç•™ GET å…¼å®¹
async def shutdown():
    """Shutdown the server"""
    import asyncio
    asyncio.create_task(delayed_shutdown())
    return {"status": "shutting down"}

async def delayed_shutdown():
    await asyncio.sleep(0.5)  # å»¶è¿Ÿ 0.5 ç§’ï¼Œç¡®ä¿å“åº”å‘é€
    os.kill(os.getpid(), signal.SIGTERM)
```

#### æ­¥éª¤ 3ï¼šå…¶ä»– HTTP å·¥å…·ï¼ˆbackend-demoï¼‰

åŒæ ·æ·»åŠ  beforeunload äº‹ä»¶ï¼ˆåœ¨å‰ç«¯ HTML ä¸­ï¼‰

---

### æ½œåœ¨é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1ï¼šåˆ·æ–°é¡µé¢ä¼šè§¦å‘ shutdown

**è§£å†³æ–¹æ¡ˆ Aï¼ˆå®½å®¹ï¼‰**ï¼š
- æ¥å—è¿™ä¸ªè¡Œä¸º
- åˆ·æ–° = é‡å¯æœåŠ¡ï¼ˆå‡ ç§’å»¶è¿Ÿï¼Œå¯æ¥å—ï¼‰
- æœ€ç®€å•

**è§£å†³æ–¹æ¡ˆ Bï¼ˆä¸¥æ ¼ï¼‰**ï¼š
```html
<script>
let isNavigating = false;

// ç›‘å¬é¡µé¢å†…å¯¼èˆªï¼ˆSPA è·¯ç”±åˆ‡æ¢ï¼‰
window.addEventListener('popstate', () => {
  isNavigating = true;
  setTimeout(() => isNavigating = false, 100);
});

window.addEventListener('beforeunload', (e) => {
  // åˆ·æ–°æ£€æµ‹
  if (performance.navigation.type === 1) {
    return;  // ä¸å‘é€ shutdown
  }

  // SPA å†…éƒ¨å¯¼èˆª
  if (isNavigating) {
    return;
  }

  // çœŸæ­£å…³é—­æ ‡ç­¾é¡µ
  navigator.sendBeacon('/api/shutdown');
});
</script>
```

#### é—®é¢˜ 2ï¼šå¤šæ ‡ç­¾é¡µåŒæ—¶æ‰“å¼€

**åœºæ™¯**ï¼š
```
ç”¨æˆ·æ‰“å¼€ä¸¤ä¸ªæ ‡ç­¾é¡µ â†’ http://127.0.0.1:8001
å…³é—­ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ â†’ å‘é€ shutdown â†’ æœåŠ¡åœæ­¢
ç¬¬äºŒä¸ªæ ‡ç­¾é¡µä¹Ÿæ— æ³•ä½¿ç”¨äº† âš ï¸
```

**è§£å†³æ–¹æ¡ˆï¼ˆå¼•ç”¨è®¡æ•°ï¼‰**ï¼š
```python
# backend
active_tabs = set()

@app.post("/api/register_tab")
async def register_tab(tab_id: str):
    active_tabs.add(tab_id)
    return {"status": "registered"}

@app.post("/api/shutdown")
async def shutdown(tab_id: str):
    active_tabs.discard(tab_id)

    # åªæœ‰æ‰€æœ‰æ ‡ç­¾é¡µéƒ½å…³é—­æ‰çœŸæ­£é€€å‡º
    if len(active_tabs) == 0:
        await delayed_shutdown()
    return {"status": "ok"}
```

**å‰ç«¯**ï¼š
```html
<script>
const tabId = crypto.randomUUID();

// é¡µé¢åŠ è½½æ—¶æ³¨å†Œ
fetch('/api/register_tab', {
  method: 'POST',
  body: JSON.stringify({ tab_id: tabId })
});

// é¡µé¢å…³é—­æ—¶æ³¨é”€
window.addEventListener('beforeunload', () => {
  navigator.sendBeacon('/api/shutdown', JSON.stringify({ tab_id: tabId }));
});
</script>
```

---

## é—®é¢˜ 2ï¼šCLI å·¥å…·çš„ç»ˆç«¯é€‰æ‹©

### å½“å‰é—®é¢˜

**ç¡¬ç¼–ç çš„ç»ˆç«¯**ï¼š
```
Windows: cmd.exeï¼ˆå›ºå®šï¼‰
macOS: Terminal.appï¼ˆå›ºå®šï¼‰
Linux: gnome-terminalï¼ˆå›ºå®šï¼‰
```

**ç”¨æˆ·æœŸæœ›**ï¼š
- Windows ç”¨æˆ·å¯èƒ½æƒ³ç”¨ï¼šGit Bashã€PowerShellã€Windows Terminalã€ConEmuã€Cmder
- macOS ç”¨æˆ·å¯èƒ½æƒ³ç”¨ï¼šiTerm2ã€Alacrittyã€Kitty
- Linux ç”¨æˆ·å¯èƒ½æƒ³ç”¨ï¼šKonsoleã€Alacrittyã€Terminator

---

### ç«å“åˆ†æ

#### æ–¹æ¡ˆ Aï¼šå…¨å±€è®¾ç½®ï¼ˆVS Code æ¨¡å¼ï¼‰â­â­â­â­â­

**è®¾è®¡**ï¼š
```
è®¾ç½® â†’ ç»ˆç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é»˜è®¤ç»ˆç«¯                    â”‚
â”‚ [ä¸‹æ‹‰é€‰æ‹©]                  â”‚
â”‚  â–¼ Windows Terminal        â”‚
â”‚    cmd.exe                 â”‚
â”‚    PowerShell              â”‚
â”‚    Git Bash                â”‚
â”‚    è‡ªå®šä¹‰...               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¡Œä¸º**ï¼š
- ç”¨æˆ·åœ¨è®¾ç½®ä¸­é€‰æ‹©é»˜è®¤ç»ˆç«¯
- æ‰€æœ‰ CLI å·¥å…·ä½¿ç”¨è¿™ä¸ªç»ˆç«¯å¯åŠ¨
- ä¿å­˜åˆ°ç”¨æˆ·é…ç½®ï¼ˆelectron-storeï¼‰

**å®ç°**ï¼š
```typescript
// settings.json
{
  "terminal": {
    "windows": "wt.exe",  // Windows Terminal
    "macOS": "iTerm",
    "linux": "gnome-terminal"
  }
}

// terminal-launcher.ts
const userTerminal = settings.get('terminal.windows');
if (userTerminal === 'wt.exe') {
  // ä½¿ç”¨ Windows Terminal
  spawn('wt.exe', ['--title', title, 'cmd', '/k', command]);
} else if (userTerminal === 'git-bash') {
  // ä½¿ç”¨ Git Bash
  spawn('C:\\Program Files\\Git\\git-bash.exe', ['-c', command]);
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç”¨æˆ·å®Œå…¨æ§åˆ¶
- âœ… ä¸€æ¬¡è®¾ç½®ï¼Œæ°¸ä¹…ç”Ÿæ•ˆ
- âœ… ç¬¦åˆ VS Code ç­‰ä¸“ä¸šå·¥å…·çš„æ¨¡å¼

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦è‡ªåŠ¨æ£€æµ‹å¯ç”¨ç»ˆç«¯
- âš ï¸ ä¸åŒç»ˆç«¯çš„å¯åŠ¨å‚æ•°ä¸åŒ

**é€‚ç”¨æ€§**ï¼šâ­â­â­â­â­ï¼ˆæœ€æ¨èï¼‰

---

#### æ–¹æ¡ˆ Bï¼šå³é”®èœå•é€‰æ‹©ï¼ˆçµæ´»æ¨¡å¼ï¼‰â­â­â­â­

**è®¾è®¡**ï¼š
```
å·¥å…·å¡ç‰‡ä¸Šå³é”®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯åŠ¨æ–¹å¼                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Windows Terminal (é»˜è®¤)  â”‚
â”‚   cmd.exe                  â”‚
â”‚   PowerShell               â”‚
â”‚   Git Bash                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ è®¾ä¸ºé»˜è®¤ç»ˆç«¯               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼š
- âœ… çµæ´»ï¼ˆæ¯æ¬¡å¯ä»¥é€‰æ‹©ä¸åŒç»ˆç«¯ï¼‰
- âœ… å‘ç°æ€§å¥½ï¼ˆå³é”®å°±èƒ½çœ‹åˆ°é€‰é¡¹ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ¯æ¬¡éƒ½è¦é€‰æ‹©ï¼ˆå¯¹äºé«˜é¢‘ä½¿ç”¨ä¸å‹å¥½ï¼‰

**é€‚ç”¨æ€§**ï¼šâ­â­â­â­

---

#### æ–¹æ¡ˆ Cï¼šæ™ºèƒ½æ£€æµ‹ç³»ç»Ÿé»˜è®¤ç»ˆç«¯â­â­â­

**æœºåˆ¶**ï¼š
```
Windows: è¯»æ³¨å†Œè¡¨æ£€æµ‹é»˜è®¤ç»ˆç«¯
  HKEY_CURRENT_USER\Console\%%Startup â†’ æ£€æµ‹ Windows Terminal

macOS: è¯» defaults æ£€æµ‹
  defaults read com.apple.LaunchServices/...

Linux: è¯» $TERMINAL ç¯å¢ƒå˜é‡æˆ– x-terminal-emulator
```

**ä¼˜ç‚¹**ï¼š
- âœ… é›¶é…ç½®ï¼ˆè‡ªåŠ¨ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ å®ç°å¤æ‚ï¼ˆè·¨å¹³å°æ£€æµ‹é€»è¾‘ï¼‰
- âŒ ä¸å¯é ï¼ˆä¸æ˜¯æ‰€æœ‰ç³»ç»Ÿéƒ½è®¾ç½®äº†é»˜è®¤ï¼‰

**é€‚ç”¨æ€§**ï¼šâ­â­â­

---

#### æ–¹æ¡ˆ Dï¼šå¯åŠ¨æ—¶è¯¢é—®ï¼ˆé¦–æ¬¡é…ç½®ï¼‰â­â­â­â­

**è®¾è®¡**ï¼š
```
é¦–æ¬¡å¯åŠ¨ CLI å·¥å…·æ—¶å¼¹çª—ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©é»˜è®¤ç»ˆç«¯                â”‚
â”‚                            â”‚
â”‚ â—‹ Windows Terminal         â”‚
â”‚ â—‹ cmd.exe                  â”‚
â”‚ â—‹ PowerShell               â”‚
â”‚ â—‹ Git Bash                 â”‚
â”‚ â—‹ è‡ªå®šä¹‰è·¯å¾„...            â”‚
â”‚                            â”‚
â”‚ [ç¡®å®š] [å–æ¶ˆ]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¼•å¯¼ç”¨æˆ·é…ç½®
- âœ… ç”¨æˆ·æœ‰é€‰æ‹©æƒ

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ‰“æ–­ç”¨æˆ·æµç¨‹

**é€‚ç”¨æ€§**ï¼šâ­â­â­â­

---

### ç»ˆç«¯æ£€æµ‹å®ç°

#### Windows ç»ˆç«¯åˆ—è¡¨

```typescript
const WINDOWS_TERMINALS = [
  {
    id: 'wt',
    name: 'Windows Terminal',
    executable: 'wt.exe',
    args: (title: string, command: string) => [
      '--title', title,
      'cmd', '/k', command
    ]
  },
  {
    id: 'cmd',
    name: 'CMD',
    executable: 'cmd.exe',
    args: (title: string, command: string) => [
      '/k', `title ${title} && ${command}`
    ]
  },
  {
    id: 'powershell',
    name: 'PowerShell',
    executable: 'powershell.exe',
    args: (title: string, command: string) => [
      '-NoExit',
      '-Command',
      `$host.ui.RawUI.WindowTitle='${title}'; ${command}`
    ]
  },
  {
    id: 'git-bash',
    name: 'Git Bash',
    executable: 'C:\\Program Files\\Git\\git-bash.exe',
    args: (title: string, command: string) => [
      '--cd-to-home',
      '-c', command
    ]
  }
];

// æ£€æµ‹å¯ç”¨ç»ˆç«¯
async function detectAvailableTerminals() {
  const available = [];
  for (const terminal of WINDOWS_TERMINALS) {
    try {
      execSync(`where ${terminal.executable}`, { timeout: 1000 });
      available.push(terminal);
    } catch {
      // ç»ˆç«¯ä¸å¯ç”¨
    }
  }
  return available;
}
```

---

## æˆ‘çš„æœ€ç»ˆæ¨èæ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šHTTP å·¥å…·æµè§ˆå™¨å…³é—­æ£€æµ‹

**æ¨è**ï¼š**æ–¹æ¡ˆ Bï¼ˆbeforeunload + sendBeaconï¼‰**

**ç†ç”±**ï¼š
- å®Œç¾åŒ¹é…ç”¨æˆ·å¿ƒæ™ºæ¨¡å‹ï¼ˆå…³é—­é¡µé¢ = åœæ­¢æœåŠ¡ï¼‰
- å®ç°æå…¶ç®€å•ï¼ˆ10 åˆ†é’Ÿï¼‰
- æˆ‘ä»¬å·²ç»å®Œå…¨æŒæ§ uiautodev å‰ç«¯ï¼ˆå¯ä»¥ä¿®æ”¹ï¼‰
- å¯é æ€§é«˜ï¼ˆsendBeacon ä¿è¯å‘é€ï¼‰

**å®æ–½æ­¥éª¤**ï¼š
1. åœ¨ `uiautodev/static/index.html` æ·»åŠ  beforeunload ç›‘å¬
2. ä¿®æ”¹ backend-demo çš„å‰ç«¯ï¼ˆå¦‚æœæœ‰ï¼‰
3. å¤„ç†åˆ·æ–°åœºæ™¯ï¼ˆå¯é€‰ï¼Œæˆ–æ¥å—åˆ·æ–°=é‡å¯ï¼‰

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
å¯åŠ¨å·¥å…· â†’ æµè§ˆå™¨æ‰“å¼€ â†’ ä½¿ç”¨ â†’ å…³é—­æ ‡ç­¾é¡µ â†’ æœåŠ¡è‡ªåŠ¨åœæ­¢ âœ…

ã€é›¶æ‰‹åŠ¨æ“ä½œï¼å®Œç¾ï¼ã€‘
```

---

### é—®é¢˜ 2ï¼šCLI å·¥å…·ç»ˆç«¯é€‰æ‹©

**æ¨è**ï¼š**æ–¹æ¡ˆ Aï¼ˆå…¨å±€è®¾ç½®ï¼‰+ æ–¹æ¡ˆ Dï¼ˆé¦–æ¬¡å¼•å¯¼ï¼‰**

**ç†ç”±**ï¼š
- ç¬¦åˆä¸“ä¸šå·¥å…·çš„æ¨¡å¼ï¼ˆVS Codeã€Gitï¼‰
- ä¸€æ¬¡è®¾ç½®ï¼Œæ°¸ä¹…ç”Ÿæ•ˆ
- å¯ä»¥åç»­æ·»åŠ å³é”®èœå•ï¼ˆä¸´æ—¶åˆ‡æ¢ï¼‰

**å®æ–½æ­¥éª¤**ï¼š
1. åœ¨è®¾ç½®é¢æ¿æ·»åŠ "é»˜è®¤ç»ˆç«¯"é€‰é¡¹
2. æ£€æµ‹ç³»ç»Ÿå¯ç”¨ç»ˆç«¯
3. é¦–æ¬¡ä½¿ç”¨ CLI å·¥å…·æ—¶å¼•å¯¼ç”¨æˆ·é€‰æ‹©
4. ä¿å­˜åˆ° electron-store

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
é¦–æ¬¡ä½¿ç”¨ï¼š
  ç‚¹å‡» CLI å·¥å…· â†’ å¼¹çª—"é€‰æ‹©é»˜è®¤ç»ˆç«¯" â†’ é€‰æ‹© Windows Terminal â†’ ç¡®å®š
                                          â†“
                                  ä¿å­˜é…ç½®ï¼Œä»¥åéƒ½ç”¨è¿™ä¸ª

åç»­ä½¿ç”¨ï¼š
  ç‚¹å‡» CLI å·¥å…· â†’ ç›´æ¥åœ¨ Windows Terminal ä¸­æ‰“å¼€ âœ…
```

---

## ç»ˆæä¼˜åŒ–è·¯çº¿å›¾

### é˜¶æ®µ 1ï¼šç«‹å³å®æ–½ï¼ˆæœ¬å‘¨ï¼‰

**HTTP å·¥å…·æµè§ˆå™¨å…³é—­æ£€æµ‹**ï¼š
- [ ] ä¿®æ”¹ uiautodev/static/index.html
- [ ] æ·»åŠ  beforeunload ç›‘å¬
- [ ] ä¿®æ”¹ /shutdown ä¸º POST
- [ ] æµ‹è¯•å…³é—­æ ‡ç­¾é¡µè‡ªåŠ¨åœæ­¢

**å·¥ä½œé‡**ï¼š1 å°æ—¶

---

### é˜¶æ®µ 2ï¼šä¸‹å‘¨å®æ–½

**CLI å·¥å…·ç»ˆç«¯é€‰æ‹©**ï¼š
- [ ] å®ç°ç»ˆç«¯æ£€æµ‹é€»è¾‘
- [ ] æ·»åŠ è®¾ç½®é¢æ¿ï¼ˆç»ˆç«¯é€‰æ‹©ï¼‰
- [ ] é¦–æ¬¡ä½¿ç”¨å¼•å¯¼
- [ ] ä¿®æ”¹ terminal-launcher.ts æ”¯æŒå¤šç»ˆç«¯

**å·¥ä½œé‡**ï¼šåŠå¤©

---

### é˜¶æ®µ 3ï¼šé•¿æœŸä¼˜åŒ–

**å…¶ä»–ä½“éªŒä¼˜åŒ–**ï¼š
- [ ] å·¥å…·ä½¿ç”¨ç»Ÿè®¡ï¼ˆå¯åŠ¨æ¬¡æ•°ã€ä½¿ç”¨æ—¶é•¿ï¼‰
- [ ] å·¥å…·æ—¥å¿—æŸ¥çœ‹ï¼ˆåœ¨ BoolTox ä¸­æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºï¼‰
- [ ] å·¥å…·å´©æºƒæ£€æµ‹å’Œé€šçŸ¥
- [ ] å·¥å…·æ€§èƒ½ç›‘æ§ï¼ˆCPU/å†…å­˜ï¼‰

**å·¥ä½œé‡**ï¼šæŒç»­è¿­ä»£

---

## å¯¹æ¯”è¡¨æ ¼

### HTTP å·¥å…·å…³é—­æ£€æµ‹

| æ–¹æ¡ˆ | å®ç°å¤æ‚åº¦ | å¯é æ€§ | ç”¨æˆ·ä½“éªŒ | æ¨èåº¦ |
|------|-----------|-------|---------|--------|
| æ–¹æ¡ˆ A: ç©ºé—²æ£€æµ‹ | ä¸­ | â­â­â­ | â­â­â­ | â­â­â­â­ |
| **æ–¹æ¡ˆ B: beforeunload** | **ä½** | **â­â­â­â­â­** | **â­â­â­â­â­** | **â­â­â­â­â­** |
| æ–¹æ¡ˆ C: WebSocket | é«˜ | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| æ–¹æ¡ˆ D: è¿›ç¨‹æ£€æµ‹ | æé«˜ | â­â­ | â­â­â­ | â­ |

### CLI å·¥å…·ç»ˆç«¯é€‰æ‹©

| æ–¹æ¡ˆ | å®ç°å¤æ‚åº¦ | çµæ´»æ€§ | ç”¨æˆ·ä½“éªŒ | æ¨èåº¦ |
|------|-----------|-------|---------|--------|
| **æ–¹æ¡ˆ A: å…¨å±€è®¾ç½®** | **ä¸­** | **â­â­â­â­** | **â­â­â­â­â­** | **â­â­â­â­â­** |
| æ–¹æ¡ˆ B: å³é”®èœå• | ä¸­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| æ–¹æ¡ˆ C: æ™ºèƒ½æ£€æµ‹ | é«˜ | â­â­â­ | â­â­â­â­ | â­â­â­ |
| æ–¹æ¡ˆ D: é¦–æ¬¡å¼•å¯¼ | ä½ | â­â­â­ | â­â­â­â­ | â­â­â­â­ |

---

## Linus è§†è§’çš„è¯„ä»·

> ğŸŸ¢ **è¿™æ‰æ˜¯è¿½æ±‚æè‡´çš„æ­£ç¡®æ–¹å‘**
>
> **é—®é¢˜ 1ï¼ˆHTTP å·¥å…·ï¼‰**ï¼š
> - å½“å‰å®ç°ï¼šåç«¯åœ¨åå°è¿è¡Œï¼Œä½†å‰ç«¯å·²å…³é—­ï¼ˆèµ„æºæµªè´¹ï¼‰
> - æ ¹æœ¬åŸå› ï¼šå‰ç«¯å’Œåç«¯æ²¡æœ‰ç»‘å®šç”Ÿå‘½å‘¨æœŸ
> - æ­£ç¡®æ–¹æ¡ˆï¼šå‰ç«¯å…³é—­ = åç«¯åœæ­¢ï¼ˆbeforeunloadï¼‰
>
> **é—®é¢˜ 2ï¼ˆç»ˆç«¯é€‰æ‹©ï¼‰**ï¼š
> - å½“å‰å®ç°ï¼šç¡¬ç¼–ç  cmd.exeï¼ˆå¿½è§†ç”¨æˆ·åå¥½ï¼‰
> - æ ¹æœ¬åŸå› ï¼šå‡è®¾æ‰€æœ‰ç”¨æˆ·ç”¨åŒä¸€ä¸ªç»ˆç«¯
> - æ­£ç¡®æ–¹æ¡ˆï¼šè®©ç”¨æˆ·é€‰æ‹©ï¼ˆå…¨å±€è®¾ç½®ï¼‰
>
> **å¥½å“å‘³çš„ä½“ç°**ï¼š
> - ä¸æ˜¯å¢åŠ å¤æ‚çš„æ£€æµ‹æœºåˆ¶ï¼ˆLock æ–‡ä»¶ï¼‰
> - è€Œæ˜¯æ”¹å˜è®¾è®¡ï¼ˆå‰ç«¯ä¸»åŠ¨é€šçŸ¥åç«¯ï¼‰
> - ä¸æ˜¯å‡è®¾ç”¨æˆ·ç¯å¢ƒï¼ˆcmd.exeï¼‰
> - è€Œæ˜¯å°Šé‡ç”¨æˆ·é€‰æ‹©ï¼ˆç»ˆç«¯è®¾ç½®ï¼‰
>
> **è®°ä½**ï¼š
> - ä¼˜é›…çš„æ–¹æ¡ˆ = ç®€å• + å¯é  + ç¬¦åˆç›´è§‰
> - beforeunload 10 è¡Œä»£ç  > Lock æ–‡ä»¶ 120 è¡Œä»£ç 
> - ç”¨æˆ·è®¾ç½® > ç¡¬ç¼–ç å‡è®¾

---

## å»ºè®®æ‰§è¡Œé¡ºåº

### ç«‹å³æ‰§è¡Œï¼ˆä»Šå¤©ï¼‰

**HTTP å·¥å…·å…³é—­æ£€æµ‹**ï¼ˆæ–¹æ¡ˆ Bï¼‰ï¼š
- å·¥ä½œé‡ï¼š1 å°æ—¶
- æ”¶ç›Šï¼šå·¨å¤§ï¼ˆç”¨æˆ·ä½“éªŒå®Œç¾ï¼‰
- é£é™©ï¼šä½

### ä¸‹å‘¨æ‰§è¡Œ

**CLI ç»ˆç«¯é€‰æ‹©**ï¼ˆæ–¹æ¡ˆ A + Dï¼‰ï¼š
- å·¥ä½œé‡ï¼šåŠå¤©
- æ”¶ç›Šï¼šå¤§ï¼ˆå°Šé‡ç”¨æˆ·åå¥½ï¼‰
- é£é™©ï¼šä¸­ï¼ˆéœ€è¦è·¨å¹³å°æµ‹è¯•ï¼‰

---

ä½ æƒ³ç°åœ¨å°±å¼€å§‹å®æ–½å—ï¼Ÿæˆ‘å¯ä»¥ï¼š

1. **å…ˆå®æ–½ HTTP å·¥å…·å…³é—­æ£€æµ‹**ï¼ˆ10 åˆ†é’Ÿæå®šï¼‰
2. **ç„¶åå®æ–½ç»ˆç«¯é€‰æ‹©**ï¼ˆåŠå¤©ï¼‰
3. **æˆ–è€…ä¸¤ä¸ªéƒ½åš**ï¼ˆå»ºè®®åˆ†ä¸¤æ¬¡ commitï¼‰

å‘Šè¯‰æˆ‘ä½ çš„é€‰æ‹©ï¼ğŸ¯

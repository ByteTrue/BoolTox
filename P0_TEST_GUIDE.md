# P0 功能测试指南

> 测试日期：2025-12-13
> 版本：0.0.1

---

## 🚀 快速开始

```bash
cd packages/client
pnpm dev
```

---

## ✅ 测试清单

### 1. 应用启动测试

- [ ] 应用正常启动，无崩溃
- [ ] 控制台无严重错误（忽略已知的 examples lint 警告）
- [ ] 托盘图标显示（任务栏右下角，蓝色 "B" 图标）
- [ ] 主窗口正常显示

**预期日志**：
```
[ToolManager] Loaded 8 tools.
[TrayService] System tray created successfully
```

---

### 2. 命令面板测试

#### 2.1 打开命令面板

- [ ] 按 `Ctrl+K`（Windows/Linux）或 `Cmd+K`（macOS）
- [ ] 命令面板从屏幕中央弹出
- [ ] 搜索框自动聚焦
- [ ] 背景有毛玻璃模糊效果

#### 2.2 搜索功能

- [ ] 输入"系统"，结果包含"系统信息监控"
- [ ] 输入"json"，结果为空或包含相关工具
- [ ] 清空搜索，显示所有工具（按上次使用时间排序）

#### 2.3 键盘导航

- [ ] 按 `↓` 键，高亮移动到下一项
- [ ] 按 `↑` 键，高亮移动到上一项
- [ ] 按 `Enter`，启动选中的工具
- [ ] 按 `Esc`，关闭命令面板

#### 2.4 鼠标操作

- [ ] 鼠标悬停在某项上，该项高亮
- [ ] 点击某项，启动对应工具
- [ ] 点击背景，关闭命令面板

---

### 3. 系统托盘测试

#### 3.1 托盘图标

- [ ] 任务栏右下角（Windows）或菜单栏（macOS）显示托盘图标
- [ ] 图标为蓝色 "B" 字母（占位图标）
- [ ] macOS 上图标自动适配系统主题

#### 3.2 单击行为

- [ ] 单击托盘图标，主窗口隐藏
- [ ] 再次单击，主窗口显示
- [ ] 窗口显示时自动聚焦到前台

#### 3.3 右键菜单

- [ ] 右键托盘图标，显示菜单
- [ ] 菜单包含：
  - "最近使用"（如果有）
  - "打开 BoolTox"
  - "偏好设置"
  - "退出"
- [ ] 点击"打开 BoolTox"，窗口显示
- [ ] 点击"退出"，应用完全退出

#### 3.4 关闭窗口行为

**默认行为（closeToTray = true）**：
- [ ] 点击窗口关闭按钮 ×
- [ ] 窗口隐藏（而不是退出）
- [ ] 托盘图标仍然存在
- [ ] 日志显示：`Window minimized to tray`

**禁用后（closeToTray = false）**：
- [ ] 打开设置页面
- [ ] 关闭"关闭到托盘"开关
- [ ] 点击窗口关闭按钮 ×
- [ ] 应用完全退出
- [ ] 托盘图标消失

---

### 4. 简化配置测试

#### 4.1 加载简化工具

- [ ] 查看控制台日志
- [ ] 日志显示：`Inferring runtime for "简化示例工具": start="python main.py", type=python, entry=main.py`
- [ ] 日志显示：`Inferred as http-service on port 8080`
- [ ] 工具列表中显示"简化示例工具"

#### 4.2 生成的配置

- [ ] 工具 ID 为：`com.booltox.simplified-demo`
- [ ] 协议版本：`^2.0.0`（无警告）
- [ ] 运行时类型：`http-service`
- [ ] 后端类型：`python`

#### 4.3 启动工具

- [ ] 点击"简化示例工具"的"打开"按钮
- [ ] 浏览器自动打开 `http://127.0.0.1:8080`
- [ ] 页面显示简化配置的说明和对比

#### 4.4 向后兼容性

- [ ] 旧格式工具（backend-demo, backend-node-demo 等）仍然正常加载
- [ ] 旧格式工具可以正常启动和停止

---

### 5. 状态显示测试

#### 5.1 http-service 工具卡片

找到任一 http-service 工具（如"系统信息监控"）：

- [ ] 卡片显示工具名称、描述、版本
- [ ] 显示"上次启动时间"（如有）
- [ ] 按钮包含：[打开] [收藏] [卸载]
- [ ] 启动工具后，显示 [打开] [停止] 按钮
- [ ] 点击"停止"，工具进程结束

#### 5.2 standalone 工具卡片

找到 standalone 工具（如"番茄钟计时器"）：

- [ ] 卡片标识"外部窗口"
- [ ] 只显示 [启动] 按钮（无"停止"）
- [ ] 启动后，"上次启动时间"更新
- [ ] 启动后，按钮仍然是 [启动]（不变为"停止"）

#### 5.3 cli 工具卡片

找到 cli 工具（如"文件管理器（CLI）"）：

- [ ] 只显示 [启动] 按钮
- [ ] 点击启动，打开系统终端
- [ ] 终端中运行工具
- [ ] "上次启动时间"更新

#### 5.4 时间格式测试

- [ ] 首次启动工具，不显示时间
- [ ] 启动后，显示"刚刚"
- [ ] 等待 2 分钟，显示"2 分钟前"
- [ ] 等待 1 小时，显示"1 小时前"

---

### 6. 设置页面测试

#### 6.1 关闭到托盘设置

- [ ] 打开设置页面
- [ ] 找到"偏好设置"区域
- [ ] 显示"关闭到托盘"开关
- [ ] 开关默认为"开启"
- [ ] 描述显示："关闭窗口时最小化到托盘"

#### 6.2 切换设置

- [ ] 点击开关，切换为"关闭"
- [ ] 描述更新为："关闭窗口时直接退出"
- [ ] 关闭设置，设置已保存
- [ ] 重启应用，设置保持

---

## 🐛 已知问题和解决方案

### 问题 1：simplified-demo 协议版本警告

**现象**：
```
[ToolManager] 工具 E:\Code\TS\BoolTox\packages\client\examples\simplified-demo 需要协议版本 ^1.0.0，但当前版本是 2.0.0
```

**解决方案**：
- ✅ 已修复：推断逻辑自动设置 `protocol: '^2.0.0'`

### 问题 2：CommandPalette 组件错误

**现象**：
```
Cannot read properties of undefined (reading 'name')
```

**解决方案**：
- ✅ 已修复：修改为 `tool.definition.name`

### 问题 3：托盘图标不显示

**可能原因**：
- SVG 生成失败
- 权限问题

**解决方案**：
- 查看控制台日志
- 检查是否有错误信息
- 如果图标不显示，可以手动添加图标文件到 `packages/client/resources/`

---

## 📋 回归测试

### 旧功能验证

确保 P0 实施没有破坏现有功能：

- [ ] 工具中心页面正常显示
- [ ] 可以安装新工具
- [ ] 可以卸载工具
- [ ] 收藏功能正常
- [ ] 设置页面其他选项正常
- [ ] 主题切换正常
- [ ] 自动更新检查正常

---

## 🎯 成功标准

### 核心体验

- ✅ 命令面板快捷键响应 < 100ms
- ✅ 托盘图标显示正常
- ✅ 简化工具成功加载和启动
- ✅ 工具卡片 UI 正确显示

### 质量标准

- ✅ 无崩溃
- ✅ 无严重错误
- ✅ 日志信息清晰
- ✅ UI 响应流畅

---

## 📝 测试报告模板

```markdown
## P0 功能测试报告

**测试人员**：
**测试日期**：
**测试环境**：Windows 11 / macOS / Linux

### 测试结果

| 功能 | 状态 | 备注 |
|------|------|------|
| 命令面板 | ✅ / ❌ |  |
| 系统托盘 | ✅ / ❌ |  |
| 简化配置 | ✅ / ❌ |  |
| 状态显示 | ✅ / ❌ |  |

### 发现的问题

1.
2.
3.

### 截图

（粘贴截图）

### 建议

（改进建议）
```

---

## 🔧 调试技巧

### 查看日志

**开发环境**：
- 控制台输出（Electron 开发者工具）
- 日志文件：`E:\Code\TS\BoolTox\packages\client\logs\`

**关键日志**：
```
[ToolManager] Inferring runtime for "简化示例工具"
[TrayService] System tray created successfully
[ModuleContext] Tool launched: xxx
```

### 常见问题

**Q1：托盘图标不显示？**
- 检查控制台是否有 `System tray created successfully`
- Windows：检查任务栏右下角隐藏图标区域
- macOS：检查菜单栏右侧

**Q2：命令面板打不开？**
- 检查是否有焦点在其他窗口
- 尝试点击主窗口后再按快捷键
- 查看控制台是否有错误

**Q3：简化工具加载失败？**
- 检查 `manifest.json` 格式
- 查看控制台的验证错误信息
- 确保 `start` 和 `version` 字段存在

---

**测试愉快！🎉**

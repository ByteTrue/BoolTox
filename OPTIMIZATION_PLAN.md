# BoolTox Client 优化计划

> 生成时间：2025-12-13
> 基于产品定位：**Client = 工具箱 + 工具市场**（一体化）
> 核心理念：**工具完全独立，BoolTox 只做启动和管理，不干涉工具运行**

---

## 目录

- [核心设计原则调整](#核心设计原则调整)
- [优化项总览](#优化项总览)
- [P0：核心体验（必须做）](#p0核心体验必须做)
- [P1：体验提升（应该做）](#p1体验提升应该做)
- [P2：技术优化（可以做）](#p2技术优化可以做)
- [P3：生态建设（长期）](#p3生态建设长期)
- [实施路线图](#实施路线图)

---

## 核心设计原则调整

### 从"管理器"到"启动器"

**原有问题**：
- 试图追踪所有工具的运行状态（running / stopped）
- cli / binary 类型工具启动后无法可靠追踪
- UI 显示的状态可能与实际不符

**调整后的定位**：
```
BoolTox = 工具启动器 + 工具市场

职责：
✅ 启动工具
✅ 管理工具安装/卸载
✅ 记录使用历史
❌ 不追踪运行状态（cli/binary 类型）
⚠️ http-service 类型可选追踪（因为有端口）
```

**UI 语义变化**：

| 变化点 | 旧方案 | 新方案 |
|--------|--------|--------|
| 状态显示 | "运行中 🟢" | "上次启动: 5分钟前" |
| 操作按钮 | [启动] [停止] | [启动]（cli/binary）<br/>[打开] [停止]（http-service） |
| 用户预期 | BoolTox 管理工具生命周期 | BoolTox 帮助启动工具 |

---

## 优化项总览

| 优先级 | 数量 | 关键项 |
|--------|------|--------|
| **P0** | 4 项 | 命令面板、系统托盘、简化 manifest、状态显示调整 |
| **P1** | 7 项 | 工具分类、截图预览、安装优化、更新检查等 |
| **P2** | 6 项 | 技术债务、错误处理、进程管理优化 |
| **P3** | 3 项 | 工作空间、脚手架、生态建设 |

---

## P0：核心体验（必须做）

### 1. 命令面板（Command Palette）

**问题**：启动工具需要 3 步（打开 BoolTox → 找工具 → 点启动），效率低。

**方案**：
- 全局快捷键：`Ctrl+Space`（macOS: `Cmd+Space`）
- 模糊搜索所有已安装工具
- 支持快捷命令：
  - `/install <工具名>` - 搜索并安装在线工具
  - `/settings` - 打开设置
  - `/update` - 检查更新

**UI 设计**：
```
┌──────────────────────────────────────┐
│ > json_                              │
├──────────────────────────────────────┤
│ 🔧 JSON 格式化              [Enter]  │
│    上次使用: 2小时前                  │
├──────────────────────────────────────┤
│ 🔧 JSON Schema 验证         [Enter]  │
│    上次使用: 3天前                    │
├──────────────────────────────────────┤
│ ⚙️ 设置                     [Enter]  │
└──────────────────────────────────────┘
```

**技术要点**：
- 使用 `fuse.js` 实现模糊搜索
- 注册全局快捷键：`globalShortcut.register()`
- 窗口显示时自动聚焦搜索框
- 支持上下键导航，Enter 启动

**影响**：⭐⭐⭐⭐⭐ 核心体验提升
**复杂度**：中等（2-3天）

---

### 2. 系统托盘（System Tray）

**问题**：关闭窗口后需要重新打开才能启动工具，不符合"工具箱"常驻的预期。

**方案**：
- 关闭窗口时最小化到托盘（可选行为，在设置中配置）
- 托盘菜单包含：
  - 最近使用的 5 个工具（快速启动）
  - "打开 BoolTox"
  - "偏好设置"
  - "退出"
- 托盘图标徽章显示运行中的 http-service 工具数量（如有）

**UI 设计**：
```
托盘菜单
├── 🔧 JSON 格式化 (最近使用)
├── 🔧 正则测试
├── 🔧 系统监控
├── ─────────────
├── 🪟 打开 BoolTox
├── ⚙️ 偏好设置
└── ❌ 退出
```

**技术要点**：
- 使用 Electron 的 `Tray` API
- 设置项：`closeToTray: boolean`
- 右键菜单支持动态更新（最近使用列表）
- Windows: 支持气球通知（工具启动成功）

**影响**：⭐⭐⭐⭐⭐ 使用频率提升
**复杂度**：简单（1-2天）

---

### 3. 简化 manifest.json（零侵入）

**问题**：当前配置有 8+ 个字段，且工具需要知道 BoolTox 协议版本（`protocol`）。

**原有配置**（复杂）：
```json
{
  "id": "com.booltox.tool-name",
  "version": "1.0.0",
  "name": "工具名称",
  "description": "描述",
  "protocol": "^2.0.0",              // ← 不应该让工具知道
  "runtime": {
    "type": "http-service",          // ← 可以推断
    "backend": {
      "type": "python",              // ← 可以推断
      "entry": "main.py",
      "port": 8001
    }
  }
}
```

**优化后配置**（极简）：
```json
{
  "name": "系统监控",
  "version": "1.0.0",
  "start": "python main.py",
  "port": 8001,
  "icon": "icon.png",
  "description": "实时监控系统资源使用情况"
}
```

**推断规则**：
| 条件 | 推断结果 |
|------|---------|
| 有 `port` 字段 | → http-service |
| 无 `port`，`start` 包含 GUI 关键词 | → standalone |
| `start` 是 `.exe` / 无扩展名 | → binary |
| 其他 | → cli |
| `start` 包含 `python` | → backend.type = python |
| `start` 包含 `node` | → backend.type = node |

**向后兼容**：
- 保留对旧格式的支持（检测到 `runtime` 字段时使用旧逻辑）
- 示例工具逐步迁移到新格式
- 文档中标记旧格式为 `@deprecated`

**影响**：⭐⭐⭐⭐⭐ 降低工具开发门槛
**复杂度**：中等（3-4天，需要兼容性测试）

---

### 4. 调整工具状态显示（接受"启动器"定位）

**问题**：cli / binary 类型工具启动后无法可靠追踪状态。

**方案**：按工具类型区分 UI

#### http-service 类型（可追踪）
```
┌─────────────────────────────────────┐
│ 系统监控 (http-service)             │
│ http://localhost:8001               │
│ ● 服务运行中                        │  ← 可以健康检查
│ [打开浏览器] [停止服务]              │
└─────────────────────────────────────┘
```

#### standalone / cli / binary 类型（不追踪）
```
┌─────────────────────────────────────┐
│ 番茄钟 (standalone)                 │
│ 上次启动: 5 分钟前                   │  ← 只记录历史
│ [启动]                              │  ← 只能启动，不能停止
└─────────────────────────────────────┘
```

**实现要点**：
- `ModuleCard` 组件根据 `runtime.type` 渲染不同 UI
- http-service 类型：
  - 定时检查端口（`http://localhost:port/health`）
  - 显示"停止"按钮，调用 `tool:stop`
- 其他类型：
  - 只记录 `lastLaunchedAt` 时间戳
  - 移除"停止"按钮
  - 移除"运行中"状态标识

**设置中说明设计选择**：
```
关于工具状态
─────────────────────────────
BoolTox 是工具启动器，而非运行容器。

对于 HTTP Service 工具，BoolTox 可以管理其生命周期。
对于 CLI/Binary 工具，启动后由系统接管，BoolTox 不再追踪。

这种设计确保工具完全独立运行，不受 BoolTox 限制。
```

**影响**：⭐⭐⭐⭐⭐ 诚实的设计，避免用户困惑
**复杂度**：中等（2-3天）

---

## P1：体验提升（应该做）

### 5. 工具分类和截图预览

**问题**：在线工具市场是平铺列表，发现效率低。

**方案 A：分类导航**
```
工具市场
├── 🔥 推荐（人工精选或下载量排序）
├── 📂 分类
│   ├── 开发工具 (12)
│   ├── 系统工具 (8)
│   ├── 效率工具 (15)
│   └── 数据处理 (6)
└── 🆕 最近更新
```

**方案 B：截图预览**

manifest.json 新增字段：
```json
{
  "name": "JSON 格式化",
  "screenshots": [
    "screenshots/main.png",
    "screenshots/settings.png"
  ]
}
```

详情弹窗展示截图轮播：
```
┌─────────────────────────────────────┐
│  [← →] Screenshot 1/2               │
│                                     │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  │     [工具截图]              │   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  JSON 格式化                        │
│  v1.2.0 · 开发工具                  │
│  [安装] [查看详情]                  │
└─────────────────────────────────────┘
```

**技术要点**：
- 分类数据从 manifest.json 的 `keywords` 或新增 `category` 字段提取
- 截图存储在工具包的 `screenshots/` 目录
- 使用 `react-slick` 或 `swiper` 实现轮播

**影响**：⭐⭐⭐⭐ 发现体验大幅提升
**复杂度**：中等（3-4天）

---

### 6. 分离工具安装和依赖准备

**问题**：首次安装 Python 工具时，依赖安装可能需要 30 秒以上，用户体验差。

**当前流程**（慢）：
```
点击安装 → 下载 → 解压 → 安装依赖 → 完成
                              ↑
                        用户在这里等待
```

**优化后流程**（快）：
```
阶段 1：安装工具（秒级）
  下载 → 解压 → 验证 → ✅ 安装完成

阶段 2：首次启动时准备环境
  点击启动 → 显示："正在准备运行环境..."
  安装 numpy (3/10) ▓▓▓░░░░░░░ 30%
  → 环境就绪 → 启动工具
```

**实现要点**：
- `tool:install` 时跳过依赖安装
- `tool:launch` 时检查 `venv` 是否存在：
  - 不存在 → 显示进度对话框 → `python:ensure`
  - 存在 → 直接启动
- 进度对话框显示具体包名和进度

**影响**：⭐⭐⭐⭐ 安装速度感知大幅提升
**复杂度**：中等（2-3天）

---

### 7. 工具更新检查和提示

**问题**：用户不知道已安装工具有新版本。

**方案**：
- 后台任务：每天检查一次在线工具清单（GitOps）
- 对比本地已安装工具的版本号
- 有更新时在工具卡片显示红点徽章
- 支持一键更新 / 批量更新全部

**UI 设计**：
```
┌─────────────────────────────────────┐
│ JSON 格式化           🔴 有更新     │
│ 当前: v1.2.0 → 最新: v1.3.0         │
│ [更新] [查看更新日志]                │
└─────────────────────────────────────┘

工具栏
[全部更新 (3)] [刷新]
```

**技术要点**：
- 新增 IPC 通道：`tool:check-updates`
- 返回 `{ toolId, currentVersion, latestVersion, changelog }[]`
- 使用 `semver` 库比较版本号
- 更新时调用 `tool:update`（复用安装逻辑）

**影响**：⭐⭐⭐⭐ 工具保持最新
**复杂度**：中等（2-3天）

---

### 8. 批量操作

**问题**：停止多个工具、卸载多个工具需要逐个操作。

**方案**：
- 工具列表增加"选择模式"按钮
- 支持多选（Checkbox）
- 批量操作：
  - 批量启动
  - 批量停止（仅 http-service）
  - 批量卸载
  - 批量导出

**UI 设计**：
```
工具中心 [选择模式 ☑]

☑ JSON 格式化
☑ 正则测试
☐ 系统监控

已选中 2 项
[启动全部] [停止全部] [卸载全部]
```

**技术要点**：
- 新增状态：`selectedToolIds: Set<string>`
- 批量操作时使用 `Promise.all()` 并发执行
- 显示进度："正在停止 2/3 个工具..."

**影响**：⭐⭐⭐ 高级用户效率提升
**复杂度**：简单（1-2天）

---

### 9. 拖拽添加本地工具

**问题**：添加本地工具需要点击按钮 → 选择文件夹，不够直观。

**方案**：
- 窗口支持拖拽文件夹或 `.zip` 文件
- 自动识别 `manifest.json`
- 验证通过后添加到本地工具列表

**UI 设计**：
```
拖拽区域（空状态时显示）
┌─────────────────────────────────────┐
│                                     │
│        📦                           │
│   拖拽工具文件夹或 zip 到这里        │
│   或                                │
│   [选择文件夹]                       │
│                                     │
└─────────────────────────────────────┘
```

**技术要点**：
- 监听 `drop` 事件
- 使用 `fs.stat()` 检查是目录还是文件
- 目录：读取 `manifest.json`
- zip：解压到临时目录 → 读取 `manifest.json`

**影响**：⭐⭐⭐ 自定义工具体验提升
**复杂度**：简单（1天）

---

### 10. manifest.json 验证优化

**问题**：格式错误时只显示"加载失败"，不知道哪里错了。

**方案**：
- 使用 JSON Schema 验证 manifest.json
- 错误信息具体到字段和行号
- 提供修复建议

**UI 设计**：
```
添加失败：manifest.json 验证错误
────────────────────────────────────
✗ 第 12 行：缺少必需字段 "start"
✗ 第 15 行："port" 必须是数字，当前是字符串

修复建议：
- 添加 "start": "python main.py"
- 修改 "port": "8001" 为 "port": 8001

[查看文档] [在编辑器中打开]
```

**技术要点**：
- 使用 `ajv` 库进行 JSON Schema 验证
- 错误信息映射到中文
- 提供文档链接

**影响**：⭐⭐⭐ 降低工具开发门槛
**复杂度**：简单（1-2天）

---

### 11. 安装失败重试机制

**问题**：网络问题导致下载失败，用户只能重新点安装。

**方案**：
- 断点续传：下载部分失败时保留已下载内容
- 自动重试：失败时自动重试 3 次（指数退避）
- 手动重试：显示"重试"按钮

**UI 设计**：
```
安装失败
────────────────────────────────
下载超时 (已重试 3 次)

可能原因：
- 网络连接不稳定
- CDN 节点异常

[重试] [取消] [切换下载源]
```

**技术要点**：
- 使用 `axios` 的 `onDownloadProgress` 记录进度
- 失败时保存 `downloadedBytes`
- 重试时使用 `Range` 请求头断点续传
- 指数退避：1s → 2s → 4s

**影响**：⭐⭐⭐ 稳定性提升
**复杂度**：中等（2-3天）

---

## P2：技术优化（可以做）

### 12. 统一 IPC 通道命名

**问题**：当前命名不一致（`tool:install` vs `get-system-info`）。

**方案**：统一为 `domain:action` 格式

| 当前 | 优化后 |
|------|--------|
| `get-system-info` | `system:get-info` |
| `auto-update:check` | `update:check` |
| `module-store:get-all` | `store:get-modules` |

**实现要点**：
- 创建 `IPC_CHANNELS` 常量文件
- 逐步迁移旧通道（保留兼容性）
- 文档中标记旧通道为 `@deprecated`

**影响**：⭐⭐ 代码质量
**复杂度**：简单（1天）

---

### 13. 统一术语（Tool / Module / Plugin）

**问题**：代码中混用三个术语，容易混淆。

**方案**：统一使用 `Tool`

| 当前 | 统一后 |
|------|--------|
| `ModuleInstance` | `Tool` |
| `PluginProcessRuntime` | `ToolProcess` |
| `module-store` | `tool-store` |

**实现要点**：
- 逐步重命名类型定义
- 保留类型别名确保兼容性
- 更新文档和注释

**影响**：⭐⭐ 代码可读性
**复杂度**：简单（1-2天）

---

### 14. 完善错误处理

**问题**：很多 IPC 调用没有错误边界，失败时 UI 可能卡死。

**方案**：
- 所有 IPC 调用包裹在 `try-catch`
- 统一错误提示组件
- 关键操作支持重试

**示例代码**：
```typescript
// 错误边界
function useToolOperation() {
  const [error, setError] = useState<Error | null>(null);

  const installTool = async (toolId: string) => {
    try {
      setError(null);
      await window.tool.install(toolId);
      toast.success('安装成功');
    } catch (err) {
      setError(err);
      toast.error('安装失败', {
        action: {
          label: '重试',
          onClick: () => installTool(toolId)
        }
      });
    }
  };

  return { installTool, error };
}
```

**影响**：⭐⭐⭐ 稳定性
**复杂度**：中等（2-3天）

---

### 15. 进程管理健壮性

**问题**：
- 僵尸进程：工具启动子进程后，父进程结束但子进程残留
- 端口冲突：启动前没检查端口是否被占用

**方案**：
- 启动前检查端口：`netstat` 或 `lsof`
- Windows 使用 `taskkill /F /T` 杀进程树
- macOS/Linux 记录进程组 ID，杀整个组

**技术要点**：
```typescript
// 端口检查
async function isPortInUse(port: number): Promise<boolean> {
  return new Promise((resolve) => {
    const server = net.createServer();
    server.once('error', () => resolve(true));
    server.once('listening', () => {
      server.close();
      resolve(false);
    });
    server.listen(port);
  });
}

// 杀进程树（Windows）
function killProcessTree(pid: number) {
  exec(`taskkill /F /T /PID ${pid}`);
}
```

**影响**：⭐⭐⭐ 稳定性
**复杂度**：中等（2-3天）

---

### 16. Python 依赖隔离

**问题**：所有 Python 工具共享虚拟环境，依赖冲突风险。

**方案**：每个工具独立虚拟环境

```
~/.booltox/
├── tools/
│   ├── json-formatter/
│   │   ├── venv/         ← 独立环境
│   │   └── main.py
│   └── system-monitor/
│       ├── venv/         ← 独立环境
│       └── main.py
```

**实现要点**：
- 安装工具时创建 `venv`
- 使用 `uv` 的速度优势弥补多环境开销
- 首次启动时安装依赖

**影响**：⭐⭐⭐ 隔离性
**复杂度**：中等（2-3天）

---

### 17. 健康检查优化

**问题**：当前只检查端口是否响应，不检查服务是否真正可用。

**方案**：支持自定义健康检查

manifest.json 新增：
```json
{
  "health": {
    "path": "/health",
    "expect": {
      "status": 200,
      "body": { "status": "ok" }
    },
    "timeout": 30000,
    "retries": 10,
    "interval": 1000
  }
}
```

**影响**：⭐⭐ 启动可靠性
**复杂度**：简单（1-2天）

---

## P3：生态建设（长期）

### 18. 工作空间（Workspace）

**场景**：开发者有不同项目，每个项目用不同工具组合。

**方案**：
```json
// ~/.booltox/workspaces/frontend-dev.json
{
  "name": "前端开发",
  "tools": [
    "json-formatter",
    "regex-tester",
    "api-debugger"
  ],
  "autoStart": true  // 切换工作空间时自动启动
}
```

**UI 设计**：
```
工作空间选择器
┌─────────────────────────────────────┐
│ ● 前端开发 (3 个工具)               │
│   后端开发 (2 个工具)               │
│   数据分析 (4 个工具)               │
│ ──────────────────────────────────  │
│ + 新建工作空间                      │
└─────────────────────────────────────┘
```

**影响**：⭐⭐⭐⭐ 高级用户价值
**复杂度**：高（5-7天）

---

### 19. 脚手架工具

**问题**：开发新工具需要手写 manifest.json 和目录结构。

**方案**：提供 CLI 脚手架

```bash
npx create-booltox-tool my-tool

✔ 选择类型: HTTP Service (Python)
✔ 端口: 8001
✔ 生成成功!

生成的文件：
my-tool/
├── manifest.json
├── main.py
├── requirements.txt
└── README.md

下一步：
  cd my-tool
  python main.py
```

**技术要点**：
- 使用 `inquirer` 交互式命令行
- 内置多种模板（Python/Node.js/Standalone）
- 自动生成最小化 manifest.json

**影响**：⭐⭐⭐ 降低开发门槛
**复杂度**：中等（3-4天）

---

### 20. 工具评分和评论

**场景**：用户想知道哪些工具好用。

**方案**：
- 在线工具市场增加评分系统（需要后端支持）
- 或使用 GitHub Issues / Discussions 作为评论区
- 工具详情页显示 GitHub Stars

**影响**：⭐⭐⭐ 生态质量
**复杂度**：高（需要后端支持）

---

## 实施路线图

### 第一阶段（2 周）：核心体验 MVP

| 任务 | 优先级 | 预计时间 |
|------|--------|---------|
| 命令面板 | P0 | 3 天 |
| 系统托盘 | P0 | 2 天 |
| 调整状态显示逻辑 | P0 | 3 天 |
| 简化 manifest.json | P0 | 4 天 |

**验收标准**：
- ✅ 用户可以用快捷键快速启动工具
- ✅ 关闭窗口后工具箱仍可用
- ✅ 所有工具类型显示一致的 UI
- ✅ 新工具只需 4 行配置

---

### 第二阶段（3 周）：体验优化

| 任务 | 优先级 | 预计时间 |
|------|--------|---------|
| 工具分类和截图 | P1 | 4 天 |
| 分离安装和依赖准备 | P1 | 3 天 |
| 工具更新检查 | P1 | 3 天 |
| 批量操作 | P1 | 2 天 |
| 拖拽添加工具 | P1 | 1 天 |
| manifest 验证优化 | P1 | 2 天 |
| 安装重试机制 | P1 | 3 天 |

**验收标准**：
- ✅ 工具市场有清晰的分类导航
- ✅ 安装工具 < 5 秒完成
- ✅ 用户知道哪些工具有更新
- ✅ 支持拖拽添加本地工具

---

### 第三阶段（2 周）：技术优化

| 任务 | 优先级 | 预计时间 |
|------|--------|---------|
| 统一 IPC 命名 | P2 | 1 天 |
| 统一术语 | P2 | 2 天 |
| 完善错误处理 | P2 | 3 天 |
| 进程管理优化 | P2 | 3 天 |
| Python 依赖隔离 | P2 | 3 天 |
| 健康检查优化 | P2 | 2 天 |

**验收标准**：
- ✅ 代码库术语一致
- ✅ 所有错误场景有友好提示
- ✅ 进程管理无残留

---

### 第四阶段（长期）：生态建设

| 任务 | 优先级 | 预计时间 |
|------|--------|---------|
| 工作空间 | P3 | 1 周 |
| 脚手架工具 | P3 | 1 周 |
| 评分评论系统 | P3 | 待定（需后端） |

---

## 成功指标（Metrics）

### 核心指标
- **启动速度**：首次启动时间 < 3 秒
- **安装速度**：工具安装完成 < 5 秒
- **快捷键使用率**：50% 的工具启动通过命令面板
- **工具更新率**：80% 的用户保持工具最新

### 质量指标
- **崩溃率**：< 0.1%
- **进程残留率**：< 1%
- **安装成功率**：> 95%

---

## 附录：技术栈

| 组件 | 技术选择 | 原因 |
|------|---------|------|
| 命令面板 | fuse.js | 轻量级模糊搜索 |
| 截图轮播 | swiper | 流畅的触摸支持 |
| JSON 验证 | ajv | 最快的 JSON Schema 验证器 |
| 进度通知 | react-hot-toast | 轻量、可定制 |
| 断点续传 | axios | 支持 Range 请求 |

---

## 备注

- 所有 P0 优化项在第一阶段必须完成
- P1 优化项根据用户反馈调整优先级
- P2 优化项可以并行进行，不阻塞功能开发
- P3 优化项需要更详细的设计文档
